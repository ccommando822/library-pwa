<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rakshapal Singh Library ERP</title>
  <style>
    :root { --primary: #1976d2; --bg: #f4f7f6; --dark: #1c1e21; --green: #2ecc71; --red: #e74c3c; --black: #000000; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--dark); }
    header { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 18px; }
    
    nav { display: flex; background: white; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 1000; }
    nav button { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-weight: bold; color: #666; }
    nav button.active { border-bottom: 3px solid var(--primary); color: var(--primary); }

    section { padding: 15px; display: none; max-width: 500px; margin: auto; }
    section.active { display: block; }
    .card { background: white; padding: 20px; margin-bottom: 15px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

    .detail-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
    .detail-content { flex: 1; }
    .detail-label { font-size: 10px; color: var(--primary); font-weight: bold; text-transform: uppercase; }
    .detail-content input { border: none; background: transparent; font-size: 16px; width: 100%; outline: none; padding: 4px 0; }
    .detail-content input:not([readonly]) { border-bottom: 1.5px solid var(--primary); background: #fffde7; }
    .pencil-btn { cursor: pointer; color: var(--primary); font-size: 18px; padding-left: 10px; }

    .wizard-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; padding: 20px; box-sizing: border-box; display: none; }
    .wizard-overlay.show { display: block; overflow-y: auto; }
    .step-card { border: 2px solid #eee; border-radius: 12px; padding: 15px; margin-bottom: 20px; transition: 0.3s; opacity: 0.6; pointer-events: none; }
    .step-active { border-color: var(--primary); background: #f0f7ff; opacity: 1; pointer-events: auto; }
    .step-num { background: var(--primary); color: white; border-radius: 50%; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 12px; }

    .player-card { background: #242526; color: #e4e6eb; border-radius: 12px; padding: 15px; display: flex; align-items: center; margin-bottom: 10px; cursor: pointer; border-left: 5px solid var(--primary); flex-wrap: wrap; }
    .player-photo { width: 50px; height: 50px; border-radius: 8px; margin-right: 12px; object-fit: cover; }
    .player-info { flex: 1; }
    .player-info b { display: block; font-size: 16px; }
    .player-info small { color: #b0b3b8; }
    .survival-stat { font-weight: bold; text-align: right; }

    .admin-nav { display: flex; background: #eee; padding: 5px; border-radius: 10px; margin-bottom: 15px; }
    .admin-nav button { flex: 1; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; background: transparent; }
    .admin-nav button.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

    .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 15px; margin-top: 10px; transition: 0.3s; }
    .btn-blue { background: var(--primary); color: white; }
    .btn-black { background: var(--black); color: white; }
    .btn-green { background: var(--green); color: white; }
    .btn-outline { background: transparent; border: 1.5px solid var(--red); color: var(--red); }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<header>Rakshapal Singh Library</header>

<nav id="main-nav">
  <button id="tab-acc" class="active" onclick="switchMain('account')">Account</button>
  <button id="tab-man" class="hidden" onclick="switchMain('manage')">Manage üõ†</button>
</nav>

<section id="account" class="active">
  <div id="loginPanel" class="card" style="text-align:center;">
    <button class="btn btn-blue" onclick="window.login()">Sign in with Google</button>
  </div>

  <div id="profilePanel" class="hidden">
    <div class="card" style="text-align:center; border-bottom: 4px solid var(--primary);">
      <img id="u-img" style="width:80px; height:80px; border-radius:50%; margin-bottom:10px;">
      <div id="status-joined" style="font-size: 12px; color: #666; font-weight: bold;">NOT JOINED YET</div>
      <div id="status-days" style="font-size: 32px; font-weight: 900; color: #ccc;">--</div>
      <div style="font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Survival Remaining</div>
    </div>

    <div class="card">
      <div class="detail-row">
        <div class="detail-content">
          <label class="detail-label">Full Name</label>
          <input type="text" id="p-name" readonly placeholder="Required">
        </div>
        <span class="pencil-btn" onclick="makeEdit('p-name')">‚úèÔ∏è</span>
      </div>
      <div class="detail-row">
        <div class="detail-content">
          <label class="detail-label">Father's Name</label>
          <input type="text" id="p-father" readonly placeholder="Required">
        </div>
        <span class="pencil-btn" onclick="makeEdit('p-father')">‚úèÔ∏è</span>
      </div>
      <div class="detail-row">
        <div class="detail-content">
          <label class="detail-label">Mobile Number</label>
          <input type="tel" id="p-phone" readonly placeholder="Required">
        </div>
        <span class="pencil-btn" onclick="makeEdit('p-phone')">‚úèÔ∏è</span>
      </div>
      <button class="btn btn-green" onclick="window.saveProfile()">Save Folder Details</button>
    </div>

    <div id="join-trigger-box">
        <button class="btn btn-blue" onclick="openWizard()">Join the Library</button>
    </div>

    <div id="active-tools" class="hidden">
        <div class="card" style="background: #f0f7ff;">
            <label class="detail-label">Renewal Panel</label>
            <select id="p-shift" onchange="calcTotal()" style="width:100%; padding:12px; margin:8px 0; border-radius:8px; border:1px solid #ccc;">
                <option value="500">Day Shift (‚Çπ500/28d)</option>
                <option value="700">Night Shift (‚Çπ700/28d)</option>
                <option value="400">Half Shift (‚Çπ400/28d)</option>
            </select>
            <input type="number" id="p-days" value="28" oninput="calcTotal()" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ccc;" placeholder="Days to buy">
            <div id="pay-summary" style="font-weight:bold; color:var(--primary); margin: 5px 0;">Total Amount: ‚Çπ500</div>
            <button class="btn btn-blue" onclick="window.doPayment()">Secure UPI Payment</button>
        </div>
        <button class="btn btn-outline" onclick="window.openLeaveWizard()">Leave Library Membership</button>
    </div>
    <button style="width:100%; background:none; border:none; color:gray; padding:20px; cursor:pointer;" onclick="window.logout()">Logout Account</button>
  </div>
</section>

<div id="joinWizard" class="wizard-overlay">
    <h2 style="color:var(--primary);">Admission Wizard</h2>
    <div id="step1" class="step-card step-active">
        <span class="step-num">1</span> <b>Verify Folder Details</b>
        <p style="font-size:13px; color:#555;">Checking if Name, Father's Name, and Mobile are filled.</p>
        <button class="btn btn-blue" onclick="window.checkStepOne()">Check & Lock Details</button>
    </div>
    <div id="step2" class="step-card">
        <span class="step-num">2</span> <b>Verify Identity</b>
        <p style="font-size:13px; color:#555;">Call Owner at <b>7500159996</b> for Admission OTP.</p>
        <input type="number" id="join-otp" placeholder="6-digit OTP" oninput="toggleProceed(this, 'proceed-btn')" style="width:100%; padding:15px; font-size:20px; border-radius:10px; border:2px solid #ddd;">
        <button id="proceed-btn" class="btn btn-black" onclick="window.verifyJoin()">Proceed</button>
    </div>
    <button class="btn" style="background:none; color:gray;" onclick="closeWizard()">Cancel</button>
</div>

<div id="leaveWizard" class="wizard-overlay">
    <h2 style="color:var(--red);">Membership Exit</h2>
    <div id="lstep1" class="step-card step-active">
        <span class="step-num">1</span> <b>Check Fees History</b>
        <p style="font-size:13px; color:#555;">Verifying if all fees are paid till date.</p>
        <button class="btn btn-blue" onclick="window.checkLeaveFees()">Verify Fees Paid</button>
    </div>
    <div id="lstep2" class="step-card">
        <span class="step-num">2</span> <b>Exit Approval</b>
        <p style="font-size:13px; color:#555;">Call Owner for Exit OTP to clear seat.</p>
        <input type="number" id="leave-otp" placeholder="6-digit OTP" oninput="toggleProceed(this, 'lproceed-btn')" style="width:100%; padding:15px; font-size:20px; border-radius:10px; border:2px solid #ddd;">
        <button id="lproceed-btn" class="btn btn-black" onclick="window.verifyLeave()">Confirm Exit</button>
    </div>
    <button class="btn" style="background:none; color:gray;" onclick="closeLeaveWizard()">Cancel</button>
</div>

<section id="manage">
    <div class="admin-nav">
        <button id="am-otp-btn" class="active" onclick="switchAdmin('otp')">Live OTPs</button>
        <button id="am-user-btn" onclick="switchAdmin('user')">Survivals</button>
    </div>
    <div id="am-pane-otp">
        <div class="card" style="background:#000; color:#0f0; font-family:monospace; min-height:100px;" id="admin-otp-list">Monitoring signals...</div>
    </div>
    <div id="am-pane-user" class="hidden"><div id="admin-survival-list"></div></div>
</section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = { apiKey: "AIzaSyDjn6u195jqewM53qb2xnrPruFnMOELAcc", authDomain: "rakshapal-singh-library-ded2e.firebaseapp.com", projectId: "rakshapal-singh-library-ded2e", storageBucket: "rakshapal-singh-library-ded2e.firebasestorage.app", messagingSenderId: "988319651464", appId: "1:988319651464:web:477fa283cddb1d1123713d" };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  let userGlobal = null;
  let survivalDays = 0;

  window.switchMain = (t) => {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.getElementById(t).classList.add('active');
    document.querySelectorAll('#main-nav button').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-'+t.substring(0,3)).classList.add('active');
  };

  window.switchAdmin = (t) => {
    document.getElementById('am-pane-otp').classList.toggle('hidden', t !== 'otp');
    document.getElementById('am-pane-user').classList.toggle('hidden', t !== 'user');
    document.getElementById('am-otp-btn').classList.toggle('active', t === 'otp');
    document.getElementById('am-user-btn').classList.toggle('active', t === 'user');
  };

  window.calcTotal = () => {
      const shiftPrice = parseInt(document.getElementById('p-shift').value);
      const days = parseInt(document.getElementById('p-days').value) || 0;
      const total = Math.round((shiftPrice / 28) * days);
      document.getElementById('pay-summary').innerText = `Total Amount: ‚Çπ${total}`;
  };

  window.makeEdit = (id) => { document.getElementById(id).readOnly = false; document.getElementById(id).focus(); };
  window.openWizard = () => document.getElementById('joinWizard').classList.add('show');
  window.closeWizard = () => { document.getElementById('joinWizard').classList.remove('show'); document.getElementById('step2').classList.remove('step-active'); };
  
  window.openLeaveWizard = () => document.getElementById('leaveWizard').classList.add('show');
  window.closeLeaveWizard = () => { document.getElementById('leaveWizard').classList.remove('show'); document.getElementById('lstep2').classList.remove('step-active'); };

  window.toggleProceed = (el, btnId) => {
    const btn = document.getElementById(btnId);
    if(el.value.length >= 6) btn.classList.replace('btn-black', 'btn-blue');
    else btn.classList.replace('btn-blue', 'btn-black');
  };

  window.login = () => signInWithPopup(auth, provider);
  window.logout = () => signOut(auth).then(() => location.reload());

  onAuthStateChanged(auth, (user) => {
    if(user) {
      userGlobal = user;
      document.getElementById('loginPanel').classList.add('hidden');
      document.getElementById('profilePanel').classList.remove('hidden');
      document.getElementById('u-img').src = user.photoURL;
      onSnapshot(doc(db, "users", user.uid), (snap) => {
        if(snap.exists()) {
          const d = snap.data();
          document.getElementById('p-name').value = d.name || "";
          document.getElementById('p-father').value = d.father || "";
          document.getElementById('p-phone').value = d.phone || "";
          if(d.joinDateISO) {
            document.getElementById('join-trigger-box').classList.add('hidden');
            document.getElementById('active-tools').classList.remove('hidden');
            document.getElementById('status-joined').innerText = "JOINED: " + d.joinDate;
            const diff = Math.floor((new Date() - new Date(d.joinDateISO)) / 86400000);
            survivalDays = (d.totalPaidDays || 0) - diff;
            const disp = document.getElementById('status-days');
            disp.innerText = survivalDays;
            disp.style.color = survivalDays >= 0 ? "var(--green)" : "var(--red)";
          }
        }
      });
      if(user.email === "c.commando822@gmail.com") {
        document.getElementById('tab-man').classList.remove('hidden');
        loadAdminData();
      }
    }
  });

  window.saveProfile = async () => {
    await setDoc(doc(db, "users", auth.currentUser.uid), {
      name: document.getElementById('p-name').value, 
      father: document.getElementById('p-father').value, 
      phone: document.getElementById('p-phone').value,
      photo: auth.currentUser.photoURL
    }, {merge: true});
    document.querySelectorAll('input').forEach(i => i.readOnly = true);
    alert("Folder Details Saved.");
  };

  window.checkStepOne = async () => {
      const name = document.getElementById('p-name').value;
      const father = document.getElementById('p-father').value;
      const phone = document.getElementById('p-phone').value;
      if(!name || !father || !phone) {
          alert("Step 1 Failed: Fill all required details first.");
      } else {
          const otp = Math.floor(100000 + Math.random() * 900000);
          await setDoc(doc(db, "signals", auth.currentUser.uid), { otp, name, type: 'Admission' });
          document.getElementById('step2').classList.add('step-active');
          alert("Step 1 Success. Ask owner for OTP.");
      }
  };

  window.verifyJoin = async () => {
    const s = await getDoc(doc(db, "signals", auth.currentUser.uid));
    if(s.exists() && s.data().otp == document.getElementById('join-otp').value) {
      const now = new Date();
      await setDoc(doc(db, "users", auth.currentUser.uid), { joinDate: now.toLocaleDateString(), joinDateISO: now.toISOString(), totalPaidDays: 0 }, {merge: true});
      await deleteDoc(doc(db, "signals", auth.currentUser.uid));
      closeWizard();
    } else alert("Invalid OTP.");
  };

  window.checkLeaveFees = async () => {
      if (survivalDays < 0) {
          alert("Step 1 Failed: Your dues are pending. Please pay till date before leaving.");
      } else {
          const otp = Math.floor(100000 + Math.random() * 900000);
          await setDoc(doc(db, "signals", auth.currentUser.uid), { otp, name: document.getElementById('p-name').value, type: 'Exit' });
          document.getElementById('lstep2').classList.add('step-active');
          alert("Step 1 Success. Ask owner for Exit OTP.");
      }
  };

  window.verifyLeave = async () => {
    const s = await getDoc(doc(db, "signals", auth.currentUser.uid));
    if(s.exists() && s.data().otp == document.getElementById('leave-otp').value) {
      await setDoc(doc(db, "users", auth.currentUser.uid), { joinDateISO: null, totalPaidDays: 0 }, {merge: true});
      await deleteDoc(doc(db, "signals", auth.currentUser.uid));
      closeLeaveWizard();
      location.reload();
    } else alert("Invalid OTP.");
  };

  window.doPayment = async () => {
    const days = parseInt(document.getElementById('p-days').value) || 0;
    const shiftPrice = parseInt(document.getElementById('p-shift').value);
    const total = Math.round((shiftPrice / 28) * days);
    window.location.href = `upi://pay?pa=7500159996@ptsbi&pn=Library&am=${total}&cu=INR`;
    if(confirm("Payment Success?")) {
      const ref = doc(db, "users", auth.currentUser.uid);
      const s = await getDoc(ref);
      await setDoc(ref, { totalPaidDays: (s.data().totalPaidDays || 0) + days, payHistory: arrayUnion(`Added ${days} days (‚Çπ${total}) on ${new Date().toLocaleDateString()}`) }, {merge: true});
    }
  };

  function loadAdminData() {
    onSnapshot(collection(db, "signals"), s => {
      let h = ""; s.forEach(d => h += `<p style='border-bottom:1px solid #333; padding:5px;'>${d.data().type} | ${d.data().name}: <b style='color:white;'>${d.data().otp}</b></p>`);
      document.getElementById('admin-otp-list').innerHTML = h || "Monitoring...";
    });
    onSnapshot(collection(db, "users"), s => {
      let h = ""; s.forEach(d => {
        const u = d.data(); if(!u.joinDateISO) return;
        const diff = Math.floor((new Date() - new Date(u.joinDateISO)) / 86400000);
        const rem = (u.totalPaidDays || 0) - diff;
        h += `<div class="player-card" onclick="this.querySelector('.fold').classList.toggle('hidden')">
          <img src="${u.photo}" class="player-photo">
          <div class="player-info"><b>${u.name}</b><small>${u.phone}</small></div>
          <div class="survival-stat" style="color:${rem >=0 ? 'var(--green)':'var(--red)'}">${rem}<br><small>SURVIVAL</small></div>
          <div class="fold hidden" style="width:100%; font-size:11px; margin-top:10px; border-top:1px solid #444; padding-top:10px;">
            <strong>HISTORY:</strong><br>${(u.history || []).join('<br>')}<br><br><strong>PAYMENTS:</strong><br>${(u.payHistory || []).join('<br>')}
          </div>
        </div>`;
      });
      document.getElementById('admin-survival-list').innerHTML = h;
    });
  }
</script>
</body>
</html>
