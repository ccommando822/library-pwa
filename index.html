<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rakshapal Singh Library ERP</title>
  <style>
    :root { --primary: #1976d2; --bg: #f4f7f6; --dark: #1c1e21; --green: #2ecc71; --red: #e74c3c; --black: #000000; --yellow: #f1c40f; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--dark); }
    header { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 18px; }
    nav { display: flex; background: white; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 1000; }
    nav button { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-weight: bold; color: #666; font-size: 13px; }
    nav button.active { border-bottom: 3px solid var(--primary); color: var(--primary); }
    section { padding: 15px; display: none; max-width: 500px; margin: auto; }
    section.active { display: block; }
    
    .card { background: white; padding: 20px; margin-bottom: 15px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .detail-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
    .detail-content { flex: 1; }
    .detail-label { font-size: 10px; color: var(--primary); font-weight: bold; text-transform: uppercase; margin-bottom: 5px; display: block; }
    .detail-content input, .detail-content textarea { border: none; background: transparent; font-size: 16px; width: 100%; outline: none; padding: 4px 0; font-family: inherit; }
    .detail-content input:not([readonly]), .detail-content textarea:not([readonly]) { border-bottom: 1.5px solid var(--primary); background: #fffde7; }
    .pencil-btn { cursor: pointer; color: var(--primary); font-size: 18px; padding-left: 10px; }
    
    .wizard-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; padding: 20px; box-sizing: border-box; display: none; }
    .wizard-overlay.show { display: block; overflow-y: auto; }
    .step-card { display: none; background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #eee; margin: 15px 0; }
    .step-active { display: block; border-left: 5px solid var(--primary); }

    .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 15px; margin-top: 10px; }
    .btn-blue { background: var(--primary); color: white; }
    .btn-green { background: var(--green); color: white; }
    .btn-outline { background: transparent; border: 1.5px solid var(--red); color: var(--red); }
    .hidden { display: none !important; }
    
    .player-card { background: #fff; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; margin-bottom: 12px; cursor: pointer; border: 1px solid #eee; position: relative; }
    .player-header { display: flex; align-items: center; justify-content: space-between; width: 100%; }
    .player-photo { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; }
    .live-srv-display { font-family: monospace; font-size: 20px; font-weight: 900; color: var(--primary); display: block; margin: 10px 0; }
    .log-container { max-height: 120px; overflow-y: auto; font-size: 11px; border-top: 1px dashed #ccc; padding-top: 5px; }
  </style>
</head>
<body>

<header>Rakshapal Singh Library</header>

<div id="joinWizard" class="wizard-overlay">
    <h2>Admission Wizard</h2>
    <div id="step1" class="step-card step-active">
        <h3>Step 1: Profile Audit</h3>
        <p>Ensure Name, Father's Name, and Address are 6+ characters.</p>
        <button class="btn btn-blue" onclick="window.checkStepOne()">Verify & Send Signal</button>
    </div>
    <div id="step2" class="step-card">
        <h3>Step 2: Owner Approval</h3>
        <input type="number" id="join-otp" placeholder="Enter 6-digit OTP" style="width:100%; padding:15px; font-size:20px; margin-bottom:10px;">
        <button class="btn btn-black" onclick="window.verifyJoin()">Complete Admission</button>
    </div>
    <button class="btn" style="color:gray;" onclick="window.closeWizard()">Cancel</button>
</div>

<nav id="main-nav">
  <button id="tab-acc" class="active" onclick="window.switchMain('account')">Account</button>
  <button id="tab-man" class="hidden" onclick="window.switchMain('manage')">Manage üõ†</button>
</nav>

<section id="account" class="active">
  <div id="loginPanel" class="card" style="text-align:center;"><button class="btn btn-blue" onclick="window.login()">Sign in with Google</button></div>
  <div id="profilePanel" class="hidden">
    <div class="card" style="text-align:center;">
      <img id="u-img" style="width:80px; height:80px; border-radius:50%; margin-bottom:10px;">
      <div id="status-joined" style="font-size: 11px; font-weight: bold; color: #666;">NOT JOINED</div>
      <div id="status-days" class="live-srv-display">00:00:00:00</div>
      <div id="join-trigger-box"><button class="btn btn-blue" onclick="window.openWizard()">Start Admission</button></div>
    </div>

    <div class="card">
      <div class="detail-row"><div class="detail-content"><label class="detail-label">Full Name</label><input type="text" id="p-name" readonly></div><span class="pencil-btn" onclick="window.makeEdit('p-name')">‚úèÔ∏è</span></div>
      <div class="detail-row"><div class="detail-content"><label class="detail-label">Father's Name</label><input type="text" id="p-father" readonly></div><span class="pencil-btn" onclick="window.makeEdit('p-father')">‚úèÔ∏è</span></div>
      <div class="detail-row"><div class="detail-content"><label class="detail-label">Mobile</label><input type="tel" id="p-phone" readonly></div><span class="pencil-btn" onclick="window.makeEdit('p-phone')">‚úèÔ∏è</span></div>
      <div class="detail-row"><div class="detail-content"><label class="detail-label">Address</label><textarea id="p-address" readonly rows="2"></textarea></div><span class="pencil-btn" onclick="window.makeEdit('p-address')">‚úèÔ∏è</span></div>
    </div>

    <div id="active-tools" class="hidden">
        <div class="card" style="background: #f0f7ff; border: 1px solid #cce5ff;">
            <select id="p-shift" onchange="window.calcTotal()" style="width:100%; padding:10px; margin-bottom:10px;">
                <option value="500">Day (‚Çπ500)</option><option value="400">Night (‚Çπ400)</option><option value="700">Both (‚Çπ700)</option>
            </select>
            <input type="number" id="p-days" value="28" max="364" oninput="window.calcTotal()" style="width:100%; padding:10px; margin-bottom:10px;">
            <div id="pay-summary" style="padding:15px; font-weight:bold; color:var(--primary); text-align:center; background:#fff; border-radius:8px; margin-bottom:10px; border:1px dashed var(--primary);">Total: ‚Çπ500</div>
            <button class="btn btn-blue" onclick="window.doPayment()">Confirm & Pay UPI</button>
        </div>
        <button class="btn btn-green" onclick="window.saveProfile()">UPDATE PROFILE DETAILS</button>
    </div>
  </div>
</section>

<section id="manage">
    <div style="display:flex; gap:5px; margin-bottom:15px;">
        <button id="am-otp-btn" class="active" onclick="window.switchAdmin('otp')" style="flex:1; padding:10px;">Signals</button>
        <button id="am-user-btn" onclick="window.switchAdmin('user')" style="flex:1; padding:10px;">Survivals</button>
        <button id="am-wifi-btn" onclick="window.switchAdmin('wifi')" style="flex:1; padding:10px;">Wi-Fi</button>
    </div>
    <div id="am-pane-otp"><div id="admin-otp-list"></div></div>
    <div id="am-pane-user" class="hidden"><div id="admin-survival-list"></div></div>
    <div id="am-pane-wifi" class="hidden">
        <div class="card">
            <label class="detail-label">Wi-Fi SSID</label>
            <input type="text" id="wifi-ssid" style="width:100%; padding:10px; margin-bottom:10px;">
            <label class="detail-label">Password</label>
            <input type="text" id="wifi-pass" style="width:100%; padding:10px;">
            <button class="btn btn-blue" onclick="window.saveWifiSettings()">Save Wi-Fi</button>
        </div>
    </div>
</section>

<div id="owner-folder-view" class="wizard-overlay">
    <button class="btn btn-black" onclick="document.getElementById('owner-folder-view').classList.remove('show')">‚Üê Back</button>
    <div id="folder-content"></div>
</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, arrayUnion, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = { 
    apiKey: "AIzaSyDjn6u195jqewM53qb2xnrPruFnMOELAcc", 
    authDomain: "rakshapal-singh-library-ded2e.firebaseapp.com", 
    projectId: "rakshapal-singh-library-ded2e", 
    storageBucket: "rakshapal-singh-library-ded2e.firebasestorage.app", 
    messagingSenderId: "988319651464", 
    appId: "1:988319651464:web:477fa283cddb1d1123713d" 
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();
  let currentUserData = {};

  const getStamp = () => new Date().toLocaleString('en-GB');

  // --- Log Renderer (Strict User vs Admin View) ---
  window.renderLogs = (history, isAdmin = false) => {
    let logs = "";
    const sorted = (history || []).slice().reverse();
    sorted.forEach(m => {
      const isString = typeof m === 'string';
      if (!isAdmin && isString) return; // User log: Payments only. Admin log: Everything.
      
      if (isString) {
        logs += `<div style="padding:5px 0; border-bottom:1px solid #eee;">${m}</div>`;
      } else {
        const type = m.status === 'Pending' ? "‚è≥Request" : m.status === 'Verified' ? "‚úÖVerified" : "‚ùåRejected";
        logs += `<div style="white-space:pre-wrap; font-family:monospace; padding:8px 0; border-bottom:1px solid #eee;">` +
                `${type}:\nReq at: (${m.reqT})\nNAME: ${m.userName}\nSHIFT: ${m.shift}\nDAYS: ${m.days}\nAMT: ‚Çπ${m.amt}` +
                (m.actionT ? `\nAction at: (${m.actionT})` : "") +
                `\n--------------------------</div>`;
      }
    });
    return logs || "No History";
  };
    window.checkStepOne = async () => {
    const n = document.getElementById('p-name').value.trim();
    const f = document.getElementById('p-father').value.trim();
    const a = document.getElementById('p-address').value.trim();
    const p = document.getElementById('p-phone').value.trim();

    if (n.length < 6 || f.length < 6 || a.length < 6) {
        alert("Name, Father, and Address must be 6+ characters.");
        return;
    }

    const otp = Math.floor(100000 + Math.random() * 900000);
    window.currentJoinOtp = otp;

    await setDoc(doc(db, "signals", "join_" + auth.currentUser.uid), {
        type: 'ADMISSION', uid: auth.currentUser.uid, name: n, phone: p, otp: otp, timestamp: getStamp(), expiresAt: Date.now() + 300000
    });

    document.getElementById('step1').classList.remove('step-active');
    document.getElementById('step2').classList.add('step-active');
    alert("Admission Signal Sent. Ask owner for OTP.");
  };

  window.saveProfile = async () => {
    const uRef = doc(db, "users", auth.currentUser.uid);
    const snap = await getDoc(uRef);
    const old = snap.data() || {};
    const fields = [{id:'p-name', k:'name', l:'name'}, {id:'p-father', k:'father', l:'father name'}, {id:'p-phone', k:'phone', l:'mobile'}, {id:'p-address', k:'address', l:'address'}];
    
    let updates = {}, logs = [];
    fields.forEach(f => {
      const newVal = document.getElementById(f.id).value.trim();
      if(newVal !== (old[f.k] || "")) {
        updates[f.k] = newVal;
        logs.push(`User updated ${f.l} from ${old[f.k] || 'empty'} ‚Üí‚Å†_‚Å†‚Üí to ‚Üí‚Å†_‚Å†‚Üí ${newVal} at ${getStamp()}`);
      }
    });

    if (Object.keys(updates).length > 0) {
      await updateDoc(uRef, { ...updates, history: arrayUnion(...logs) });
      alert("Profile Saved.");
      fields.forEach(f => document.getElementById(f.id).readOnly = true);
    }
  };
    window.openUser = async (uid) => {
    const snap = await getDoc(doc(db, "users", uid));
    const u = snap.data();
    document.getElementById('folder-content').innerHTML = `
      <div class="card" style="text-align:center;">
        <img src="${u.photo||''}" style="width:70px; height:70px; border-radius:50%; border:2px solid var(--primary);">
        <div class="admin-live-srv live-srv-display" data-iso="${u.joinDateISO}" data-paid="${u.totalPaidDays}">${window.formatTime(window.getRealSurvival(u))}</div>
      </div>
      <div class="card">
        <p><b>Email:</b> ${u.email || '-'}</p>
        <p><b>Mobile:</b> ${u.phone || '-'}</p>
        <p><b>Address:</b> ${u.address || '-'}</p>
        <label class="detail-label">Adjust Balance (+/- Days)</label>
        <div style="display:flex; gap:5px;"><input type="number" id="adm-manual-days" style="flex:1;"><button class="btn-blue" onclick="window.adminEditDays('${uid}')">Set</button></div>
      </div>
      <div class="card"><label class="detail-label">Full Manage Log</label><div class="log-container expanded">${window.renderLogs(u.history, true)}</div></div>`;
    document.getElementById('owner-folder-view').classList.add('show');
  };

  // --- Auth Listener ---
  onAuthStateChanged(auth, async (user) => {
    if(user) {
      const uRef = doc(db, "users", user.uid);
      onSnapshot(uRef, (snap) => {
        if(snap.exists()) {
          currentUserData = snap.data();
          document.getElementById('loginPanel').classList.add('hidden');
          document.getElementById('profilePanel').classList.remove('hidden');
          document.getElementById('u-img').src = user.photoURL;
          ['name','father','phone','address'].forEach(k => {
             const el = document.getElementById('p-'+k);
             if(el && !el.readOnly) return; 
             if(el) el.value = currentUserData[k] || "";
          });
          document.getElementById('user-pay-log').innerHTML = window.renderLogs(currentUserData.history, false);
          if(user.email === "c.commando822@gmail.com") {
             document.getElementById('tab-man').classList.remove('hidden');
             window.loadAdmin();
          }
        }
      });
    }
  });

  // Helpers
  window.calcTotal = () => {
    const d = document.getElementById('p-days').value;
    const s = document.getElementById('p-shift').value;
    document.getElementById('pay-summary').innerText = `Total: ‚Çπ${Math.round((s/28)*d)}`;
  };
  window.switchMain = (t) => { document.querySelectorAll('section').forEach(s => s.classList.remove('active')); document.getElementById(t).classList.add('active'); };
  window.makeEdit = (id) => { document.getElementById(id).readOnly = false; document.getElementById(id).focus(); };
  window.formatTime = (decimalDays) => { /* logic provided in previous parts */ };
  window.getRealSurvival = (u) => { /* logic provided in previous parts */ };
</script>
</body>
</html>
