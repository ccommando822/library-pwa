<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rakshapal Singh Library</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json" />
  <style>
    body { margin: 0; font-family: sans-serif; background: #f4f6f8; color: #333; }
    header { background: #1976d2; color: white; padding: 15px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 100; }
    nav { display: flex; background: white; border-bottom: 1px solid #ddd; position: sticky; top: 50px; z-index: 99; }
    nav button { flex: 1; padding: 12px; border: none; background: none; cursor: pointer; font-size: 13px; }
    nav button.active { border-bottom: 3px solid #1976d2; color: #1976d2; font-weight: bold; }
    section { padding: 15px; display: none; }
    section.active { display: block; }
    .card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .hidden { display: none !important; }
    button.primary { width: 100%; padding: 12px; background: #1976d2; color: white; border: none; border-radius: 4px; margin-top: 10px; font-weight: bold; cursor: pointer; }
    button.danger { width: 100%; padding: 12px; background: #d32f2f; color: white; border: none; border-radius: 4px; margin-top: 10px; cursor: pointer; }
    input, select { width: 100%; padding: 10px; margin-top: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    label { font-size: 11px; color: #1976d2; font-weight: bold; display: block; margin-top: 10px; text-transform: uppercase; }
    .otp-box { background: #fffde7; padding: 10px; border: 1px dashed #fbc02d; text-align: center; margin-top: 10px; }
  </style>
</head>
<body>

<header>ðŸ“š Rakshapal Singh Library</header>

<nav>
  <button id="tab-home" class="active" onclick="window.openTab('home')">Home</button>
  <button id="tab-owner" onclick="window.openTab('owner')">Owner</button>
  <button id="tab-account" onclick="window.openTab('account')">Account</button>
  <button id="tab-admin" class="hidden" onclick="window.openTab('admin')">Manage ðŸ› </button>
</nav>

<section id="home" class="active">
  <div class="card"><h3>Safe Study Space</h3><p>Verify your identity via phone call to the owner for all library actions.</p></div>
</section>

<section id="owner">
  <div class="card">
    <h3>Owner Contact</h3>
    <p><b>Rakshapal Singh</b></p>
    <a href="tel:7500159996" style="color: #1976d2; font-size: 18px; text-decoration: none; font-weight: bold;">ðŸ“ž 7500159996</a>
  </div>
</section>

<section id="account">
  <div id="publicView" class="card" style="text-align:center">
    <button class="primary" onclick="window.login()">Sign in with Google</button>
  </div>

  <div id="userView" class="hidden">
    <div class="card" style="text-align:center">
      <img id="userImg" src="" style="width: 60px; border-radius: 50%;">
      <p id="displayUserStatus" style="font-weight:bold; color:#1976d2">Visitor</p>
    </div>

    <div class="card">
      <label>Full Name</label><input type="text" id="profName">
      <label>Father's Name</label><input type="text" id="profFather">
      <label>Mobile Number</label><input type="tel" id="profPhone">
      <button class="primary" style="background: #4caf50;" onclick="window.saveProfile()">Update Profile</button>
    </div>

    <div id="joinSection" class="card">
      <h3>Step 1: Payment</h3>
      <select id="shift" onchange="window.calculate()"><option value="500">Day</option><option value="400">Night</option><option value="700">Both</option></select>
      <input type="number" id="days" value="28" oninput="window.calculate()">
      <p><b>Total: â‚¹<span id="total">500</span></b></p>
      <button class="primary" onclick="window.payAndRequest()">Pay & Get Code</button>
      
      <div id="joinOtpArea" class="hidden otp-box">
        <p><b>Step 2: Call 7500159996 for OTP</b></p>
        <input type="number" id="joinOtpInput" placeholder="Enter 6-digit Code">
        <button class="primary" onclick="window.verifyOtp('JOIN')">Verify & Join</button>
      </div>
    </div>

    <div id="memberSection" class="hidden">
       <div class="card" style="border-top: 5px solid #4caf50;">
         <h3 style="color: green;">Member Panel âœ…</h3>
         <button class="danger" onclick="window.initiateLeave()">Request to Leave</button>
         
         <div id="leaveOtpArea" class="hidden otp-box">
           <p><b>Call Owner for Exit OTP</b></p>
           <input type="number" id="leaveOtpInput" placeholder="Enter 6-digit Code">
           <button class="primary" onclick="window.verifyOtp('LEAVE')">Confirm Exit</button>
         </div>
       </div>
    </div>

    <button onclick="window.logout()" style="width:100%; border:none; background:none; color:gray; margin-top:20px;">Logout</button>
  </div>
</section>

<section id="admin">
  <div class="card">
    <h3>Live OTP Signals</h3>
    <div id="requestList">No active signals.</div>
  </div>
</section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, updateDoc, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDjn6u195jqewM53qb2xnrPruFnMOELAcc",
    authDomain: "rakshapal-singh-library-ded2e.firebaseapp.com",
    projectId: "rakshapal-singh-library-ded2e",
    storageBucket: "rakshapal-singh-library-ded2e.firebasestorage.app",
    messagingSenderId: "988319651464",
    appId: "1:988319651464:web:477fa283cddb1d1123713d"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  let currentUser = null;
  let activeOtp = null;

  window.login = () => signInWithPopup(auth, provider);
  window.logout = () => signOut(auth).then(() => location.reload());
  window.openTab = (t) => {
    document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
    document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
    document.getElementById(t).classList.add("active");
    document.getElementById("tab-" + t).classList.add("active");
  };
  window.calculate = () => {
    const rate = document.getElementById("shift").value;
    const days = document.getElementById("days").value || 0;
    document.getElementById("total").innerText = Math.round((rate/28) * days);
  };

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById("publicView").classList.add("hidden");
      document.getElementById("userView").classList.remove("hidden");
      document.getElementById("userImg").src = user.photoURL;
      
      const uDoc = await getDoc(doc(db, "users", user.uid));
      if (uDoc.exists()) {
        const d = uDoc.data();
        document.getElementById("profName").value = d.name || user.displayName;
        document.getElementById("profPhone").value = d.phone || "";
        document.getElementById("profFather").value = d.father || "";
      } else {
        document.getElementById("profName").value = user.displayName;
      }

      if (user.email === 'c.commando822@gmail.com') {
        document.getElementById("displayUserStatus").innerText = "OWNER ðŸ‘‘";
        document.getElementById("tab-admin").classList.remove("hidden");
        listenToRequests();
      }
      listenToUserStatus(user.uid);
    }
  });

  window.saveProfile = async () => {
    const data = {
      name: document.getElementById("profName").value,
      phone: document.getElementById("profPhone").value,
      father: document.getElementById("profFather").value
    };
    await setDoc(doc(db, "users", currentUser.uid), data, { merge: true });
    alert("Profile Saved!");
  };

  window.payAndRequest = () => {
    const amount = document.getElementById("total").innerText;
    window.location.href = `upi://pay?pa=7500159996@ybl&pn=Rakshapal%20Singh&am=${amount}&cu=INR`;
    setTimeout(() => {
      const txn = prompt("Enter UPI Transaction ID:");
      if(txn) {
        sendSignal("JOIN", amount, txn);
        document.getElementById("joinOtpArea").classList.remove("hidden");
      }
    }, 2000);
  };

  window.initiateLeave = () => {
    if(confirm("Have you cleared fees till today?")) {
      sendSignal("LEAVE", 0, "N/A");
      document.getElementById("leaveOtpArea").classList.remove("hidden");
    }
  };

  async function sendSignal(type, amount, txn) {
    const otp = Math.floor(100000 + Math.random() * 900000);
    await setDoc(doc(db, "signals", currentUser.uid), {
      uid: currentUser.uid,
      name: document.getElementById("profName").value,
      phone: document.getElementById("profPhone").value,
      type, amount, txn, otp, time: Date.now()
    });
  }

  window.verifyOtp = async (type) => {
    const input = document.getElementById(type === 'JOIN' ? 'joinOtpInput' : 'leaveOtpInput').value;
    const sDoc = await getDoc(doc(db, "signals", currentUser.uid));
    if (sDoc.exists() && sDoc.data().otp == input) {
      await setDoc(doc(db, "users", currentUser.uid), { status: (type === 'JOIN' ? 'MEMBER' : 'VISITOR') }, { merge: true });
      await deleteDoc(doc(db, "signals", currentUser.uid));
      alert("Verified! Status Updated.");
      location.reload();
    } else {
      alert("Wrong Code! Call Owner again.");
    }
  };

  function listenToRequests() {
    onSnapshot(collection(db, "signals"), (snap) => {
      let html = "";
      snap.forEach(d => {
        const r = d.data();
        html += `<div class="card" style="border-left:5px solid red">
          <p><b>${r.name}</b> (${r.phone})</p>
          <p>Reason: ${r.type} | Txn: ${r.txn}</p>
          <p style="font-size:20px; color:blue">OTP: <b>${r.otp}</b></p>
        </div>`;
      });
      document.getElementById("requestList").innerHTML = html || "No calls expected.";
    });
  }

  function listenToUserStatus(uid) {
    onSnapshot(doc(db, "users", uid), (d) => {
      const s = d.exists() ? d.data().status : "VISITOR";
      if(s === "MEMBER") {
        document.getElementById("joinSection").classList.add("hidden");
        document.getElementById("memberSection").classList.remove("hidden");
      } else {
        document.getElementById("joinSection").classList.remove("hidden");
        document.getElementById("memberSection").classList.add("hidden");
      }
    });
  }
</script>
</body>
</html>
