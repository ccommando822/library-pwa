<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rakshapal Singh Library ERP</title>
  <style>
    :root { --primary: #1976d2; --bg: #f4f7f6; --dark: #1c1e21; --green: #2ecc71; --red: #e74c3c; --black: #000000; --yellow: #f1c40f; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--dark); }
    header { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 18px; }
    nav { display: flex; background: white; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 1000; }
    nav button { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-weight: bold; color: #666; font-size: 13px; }
    nav button.active { border-bottom: 3px solid var(--primary); color: var(--primary); }
    section { padding: 15px; display: none; max-width: 500px; margin: auto; }
    section.active { display: block; }
    
    .card { background: white; padding: 20px; margin-bottom: 15px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .detail-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
    .detail-content { flex: 1; }
    .detail-label { font-size: 10px; color: var(--primary); font-weight: bold; text-transform: uppercase; margin-bottom: 5px; display: block; }
    .detail-content input, .detail-content textarea { border: none; background: transparent; font-size: 16px; width: 100%; outline: none; padding: 4px 0; font-family: inherit; }
    .detail-content input:not([readonly]), .detail-content textarea:not([readonly]) { border-bottom: 1.5px solid var(--primary); background: #fffde7; }
    .pencil-btn { cursor: pointer; color: var(--primary); font-size: 18px; padding-left: 10px; }
    
    .wizard-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; padding: 20px; box-sizing: border-box; display: none; }
    .wizard-overlay.show { display: block; overflow-y: auto; }
    .step-card { display: none; background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #eee; margin: 15px 0; }
    .step-active { display: block; border-left: 5px solid var(--primary); }
    .step-num { display: inline-block; width: 25px; height: 25px; background: var(--primary); color: white; text-align: center; border-radius: 50%; font-size: 14px; margin-right: 10px; }

    #pay-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:3000; display:none; align-items:center; justify-content:center; }
    .modal-box { background:white; padding:30px; border-radius:15px; width:80%; max-width:350px; text-align:center; }
    
    /* Updated Player/Survival Card Design */
    .player-card { background: #fff; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; margin-bottom: 12px; cursor: pointer; border: 1px solid #eee; box-shadow: 0 2px 4px rgba(0,0,0,0.03); position: relative; }
    .player-header { display: flex; align-items: center; justify-content: space-between; width: 100%; }
    .player-info { display: flex; align-items: center; }
    .player-photo { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; border: 2px solid #eee; }
    .player-details { display: flex; flex-direction: column; font-size: 12px; color: #555; margin-top: 8px; border-top: 1px dashed #eee; padding-top: 5px; }
    .status-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    
    .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 15px; margin-top: 10px; }
    .btn-blue { background: var(--primary); color: white; }
    .btn-green { background: var(--green); color: white; }
    .btn-outline { background: transparent; border: 1.5px solid var(--red); color: var(--red); }
    .hidden { display: none !important; }
    
    .log-container { max-height: 100px; overflow: hidden; font-size: 11px; margin-top: 8px; display: flex; flex-direction: column; cursor: pointer; border-top: 1px dashed #ccc; padding-top: 5px; transition: max-height 0.3s ease-out; }
    .log-container.expanded { max-height: none; }
    
    .sig-timer { float: right; color: var(--yellow); font-size: 12px; font-weight: bold; background: #333; padding: 2px 8px; border-radius: 4px; }
    .live-srv-display { font-family: monospace; font-size: 20px; font-weight: 900; color: var(--primary); display: block; margin: 10px 0; letter-spacing: 1px; }
  </style>
</head>
<body>

<header>Rakshapal Singh Library</header>

<div id="pay-modal" onclick="this.style.display='none'">
    <div class="modal-box"><h3>Payment Sent</h3><p>Waiting for verification...</p><p style="font-weight:bold; color:var(--red);">Call 7500159996</p></div>
</div>

<div id="joinWizard" class="wizard-overlay">
    <h2>Admission Wizard</h2>
    <div id="step1" class="step-card step-active">
        <span class="step-num">1</span> <b>Verify Profile Folder</b>
        <p style="font-size:12px; color:#666;">Name, Father, and Address must have 6+ letters.</p>
        <button class="btn btn-blue" onclick="window.checkStepOne()">Check & Send Signal</button>
    </div>
    <div id="step2" class="step-card">
        <span class="step-num">2</span> <b>Verify Identity (OTP)</b>
        <input type="number" id="join-otp" placeholder="Enter 6-digit OTP" style="width:100%; padding:15px; font-size:20px; border-radius:10px; border:2px solid #ddd; margin-bottom:10px;">
        <button class="btn btn-black" onclick="window.verifyJoin()">Complete Admission</button>
    </div>
    <button class="btn" style="background:none; color:gray;" onclick="window.closeWizard()">Cancel</button>
</div>

<div id="leaveWizard" class="wizard-overlay">
    <h2>Membership Exit</h2>
    <div id="lstep1" class="step-card step-active">
        <span class="step-num">1</span> <b>Check Balance</b>
        <div id="leave-error-box" class="hidden"><p id="leave-error-msg" style="color:var(--red); font-weight:bold;"></p></div>
        <button id="leave-verify-btn" class="btn btn-blue" onclick="window.checkLeaveFees()">Verify Fees & Signal</button>
    </div>
    <div id="lstep2" class="step-card">
        <span class="step-num">2</span> <b>Final Approval</b>
        <input type="number" id="leave-otp" placeholder="Enter 6-digit OTP" style="width:100%; padding:15px; font-size:20px; border-radius:10px; border:2px solid #ddd; margin-bottom:10px;">
        <button class="btn btn-black" onclick="window.verifyLeave()">Confirm Exit</button>
    </div>
    <button class="btn" style="background:none; color:gray;" onclick="window.closeLeaveWizard()">Cancel</button>
</div>

<nav id="main-nav">
  <button id="tab-acc" class="active" onclick="switchMain('account')">Account</button>
  <button id="tab-man" class="hidden" onclick="switchMain('manage')">Manage üõ†</button>
</nav>

<section id="account" class="active">
  <div id="loginPanel" class="card" style="text-align:center;"><button class="btn btn-blue" onclick="window.login()">Sign in with Google</button></div>
  <div id="profilePanel" class="hidden">
    <div class="card" style="text-align:center;">
      <img id="u-img" style="width:80px; height:80px; border-radius:50%; margin-bottom:10px; cursor:pointer;" onclick="document.getElementById('photo-input').click()">
      <input type="file" id="photo-input" class="hidden" accept="image/*" onchange="window.updateUserPhoto(this)">
      <div id="status-joined" style="font-size: 11px; font-weight: bold; color: #666;">NOT JOINED</div>
      
      <div id="status-days" class="live-srv-display">00:00:00:00</div>
      
      <div id="join-trigger-box"><button class="btn btn-blue" onclick="window.openWizard()">Start Admission</button></div>
      
      <div id="wifi-connect-trigger" class="hidden" style="margin-top:10px;">
        <button class="btn btn-green" onclick="window.connectToWifi()">üõú Connect to Internet</button>
      </div>
    </div>

    <div class="card">
      <div class="detail-row"><div class="detail-content"><label class="detail-label">Full Name</label><input type="text" id="p-name" readonly></div><span class="pencil-btn" onclick="makeEdit('p-name')">‚úèÔ∏è</span></div>
      <div class="detail-row"><div class="detail-content"><label class="detail-label">Father's Name</label><input type="text" id="p-father" readonly></div><span class="pencil-btn" onclick="makeEdit('p-father')">‚úèÔ∏è</span></div>
      <div class="detail-row"><div class="detail-content"><label class="detail-label">Mobile</label><input type="tel" id="p-phone" readonly></div><span class="pencil-btn" onclick="makeEdit('p-phone')">‚úèÔ∏è</span></div>
      <div class="detail-row"><div class="detail-content"><label class="detail-label">Address</label><textarea id="p-address" readonly rows="2"></textarea></div><span class="pencil-btn" onclick="makeEdit('p-address')">‚úèÔ∏è</span></div>
      <button class="btn btn-green" onclick="window.saveProfile()">Update Folder Details</button>
    </div>

    <div id="active-tools" class="hidden">
        <div class="card" style="background: #f0f7ff;">
            <select id="p-shift" onchange="calcTotal()" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px;"><option value="500">Day (‚Çπ500)</option><option value="400">Night (‚Çπ400)</option><option value="700">Both (‚Çπ700)</option></select>
            <input type="number" id="p-days" value="28" oninput="calcTotal()" style="width:100%; padding:10px; border-radius:8px;">
            <div id="pay-summary" style="padding:10px; font-weight:bold; color:var(--primary); text-align:center;">Total: ‚Çπ500</div>
            <button class="btn btn-blue" onclick="window.doPayment()">Pay Now</button>
        </div>
        <button class="btn btn-outline" onclick="window.openLeaveWizard()">Membership Exit</button>
    </div>
    
    <div class="card"><label class="detail-label">Payment History</label><div id="user-pay-log" class="log-container" onclick="this.classList.toggle('expanded')"></div></div>
    <button style="width:100%; border:none; color:gray; padding:20px; cursor:pointer;" onclick="window.logout()">Logout</button>
  </div>
</section>

<section id="manage">
    <div style="display:flex; gap:5px; margin-bottom:15px;">
        <button id="am-otp-btn" class="active" onclick="switchAdmin('otp')" style="flex:1; padding:10px; border-radius:8px; border:none; font-weight:bold;">Signals</button>
        <button id="am-user-btn" onclick="switchAdmin('user')" style="flex:1; padding:10px; border-radius:8px; border:none; font-weight:bold;">Survivals</button>
        <button id="am-wifi-btn" onclick="switchAdmin('wifi')" style="flex:1; padding:10px; border-radius:8px; border:none; font-weight:bold;">Wi-Fi</button>
    </div>
    
    <div id="am-pane-otp"><div id="admin-otp-list"></div></div>
    <div id="am-pane-user" class="hidden"><div id="admin-survival-list"></div></div>
    
    <div id="am-pane-wifi" class="hidden">
        <div class="card">
            <label class="detail-label">Library Wi-Fi SSID</label>
            <input type="text" id="wifi-ssid" placeholder="Enter Wi-Fi Name" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; margin-bottom:15px;">
            <label class="detail-label">Wi-Fi Password</label>
            <input type="text" id="wifi-pass" placeholder="Enter Wi-Fi Password" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:10px;">
            <button class="btn btn-blue" onclick="window.saveWifiSettings()">Update Wi-Fi</button>
        </div>
    </div>
</section>

<div id="owner-folder-view" class="wizard-overlay"><button class="btn btn-black" onclick="document.getElementById('owner-folder-view').classList.remove('show')">‚Üê Back</button><div id="folder-content"></div></div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, arrayUnion, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = { 
    apiKey: "AIzaSyDjn6u195jqewM53qb2xnrPruFnMOELAcc", 
    authDomain: "rakshapal-singh-library-ded2e.firebaseapp.com", 
    projectId: "rakshapal-singh-library-ded2e", 
    storageBucket: "rakshapal-singh-library-ded2e.firebasestorage.app", 
    messagingSenderId: "988319651464", 
    appId: "1:988319651464:web:477fa283cddb1d1123713d" 
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  let currentUserData = {};
  const getStamp = () => new Date().toLocaleString('en-GB');

  // --- Core Helpers ---
  
  // Convert Decimal to D:H:M:S
  window.formatTime = (decimalDays) => {
    // Show 00... if negative (debt) or empty, but handle negative separately if needed
    // For now, if < 0 it will just show -00:.. roughly or we can floor it. 
    // The previous code handled negative by color, so here we format the absolute value mostly
    if (decimalDays === undefined) return "00:00:00:00";
    
    let sign = decimalDays < 0 ? "-" : "";
    let totalSeconds = Math.floor(Math.abs(decimalDays) * 86400);
    let d = Math.floor(totalSeconds / 86400);
    let h = Math.floor((totalSeconds % 86400) / 3600);
    let m = Math.floor((totalSeconds % 3600) / 60);
    let s = totalSeconds % 60;
    return `${sign}${d.toString().padStart(2, '0')}:${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
  };

  // Logic: 
  // If Joined (joinDateISO exists) -> Calculate: Paid - (Now - Join)
  // If Left (joinDateISO is null)  -> Return: Paid (Static)
  window.getRealSurvival = (u) => {
    if(!u.joinDateISO) return u.totalPaidDays || 0;
    return (u.totalPaidDays || 0) - ((new Date() - new Date(u.joinDateISO)) / 86400000);
  };

  // --- Reverted Log Renderer (Base Code Layout) ---
  window.renderLogs = (history) => {
  let out = "";
  (history || []).slice().reverse().forEach(h => {

    // SIMPLE STRING LOGS (join/leave etc.)
    if (typeof h === "string") {
      out += `<div style="padding:6px 0;border-bottom:1px solid #eee;">${h}</div>`;
      return;
    }

    // PAYMENT LOGS
    if (h.status === "Pending") {
      out += `
<pre style="font-family:monospace; margin:0;">
‚è≥Request:
Request at :- (${h.reqT})

NAME   : ${currentUserData.name}
PHONE  : ${currentUserData.phone}
SHIFT  : ${h.shift}
DAYS   : ${h.days}
AMOUNT : ‚Çπ${h.amt}
--------------------------
</pre>`;
    }

    if (h.status === "Verified") {
      out += `
<pre style="font-family:monospace; margin:0;">
‚úÖVerified:
Request at :- (${h.reqT})

NAME   : ${currentUserData.name}
PHONE  : ${currentUserData.phone}
SHIFT  : ${h.shift}
DAYS   : ${h.days}
AMOUNT : ‚Çπ${h.amt}

Verified at :- (${h.actionT})
--------------------------
</pre>`;
    }

    if (h.status === "Rejected") {
      out += `
<pre style="font-family:monospace; margin:0;">
‚ùåRejected:
Request at :- (${h.reqT})

NAME   : ${currentUserData.name}
PHONE  : ${currentUserData.phone}
SHIFT  : ${h.shift}
DAYS   : ${h.days}
AMOUNT : ‚Çπ${h.amt}

Rejected at :- (${h.actionT})
--------------------------
</pre>`;
    }
  });

  return out || "No payment history.";
};

  // --- Auth & Data Listener ---
  onAuthStateChanged(auth, async (user) => {
    if(user) {
      const uRef = doc(db, "users", user.uid);
      // Save EMAIL here so Admin can see it
      await updateDoc(uRef, { isOnline: true, email: user.email }).catch(async () => {
          await setDoc(uRef, { 
              name: user.displayName, 
              email: user.email, // Saved Email
              photo: user.photoURL, 
              isOnline: true, 
              totalPaidDays: 0, 
              history: [] 
          });
      });

      onSnapshot(uRef, (snap) => {
        if(snap.exists()) {
          currentUserData = snap.data();
         // üîπ LOAD SAVED WI-FI SETTINGS (OWNER ONLY)
if (user.email === "c.commando822@gmail.com") {
  getDoc(doc(db, "settings", "wifi")).then(wSnap => {
    if (wSnap.exists()) {
      document.getElementById('wifi-ssid').value = wSnap.data().ssid || "";
      document.getElementById('wifi-pass').value = wSnap.data().pass || "";
    }
  });
} document.getElementById('loginPanel').classList.add('hidden');
          document.getElementById('profilePanel').classList.remove('hidden');
          document.getElementById('u-img').src = currentUserData.photo || user.photoURL;
          
          ['name','father','phone','address'].forEach(k => {
              const el = document.getElementById('p-'+k);
              if(el) el.value = currentUserData[k] || "";
          });

          // Join/Leave State & Timer Visibility
          const srv = window.getRealSurvival(currentUserData);
          document.getElementById('status-days').innerText = window.formatTime(srv);
          document.getElementById('status-days').style.color = srv >= 0 ? "var(--green)" : "var(--red)";

          if(currentUserData.joinDateISO) {
             // JOINED: Timer will move (handled in setInterval)
             document.getElementById('join-trigger-box').classList.add('hidden');
             document.getElementById('active-tools').classList.remove('hidden');
             document.getElementById('wifi-connect-trigger').classList.remove('hidden');
             document.getElementById('status-joined').innerText = "JOINED: " + currentUserData.joinDate;
          } else {
             // LEFT: Timer is STATIC (shows remaining balance)
             document.getElementById('join-trigger-box').classList.remove('hidden');
             document.getElementById('active-tools').classList.add('hidden');
             document.getElementById('wifi-connect-trigger').classList.add('hidden'); // Hide Wifi button if left
             document.getElementById('status-joined').innerText = "NOT JOINED";
          }
          
          document.getElementById('user-pay-log').innerHTML = window.renderLogs(currentUserData.history);
          
          if(user.email === "c.commando822@gmail.com") {
             document.getElementById('tab-man').classList.remove('hidden');
             window.loadAdmin();
          }
        }
      });
    } else {
      document.getElementById('loginPanel').classList.remove('hidden');
      document.getElementById('profilePanel').classList.add('hidden');
      document.getElementById('tab-man').classList.add('hidden');
    }
  });

  // --- Removed Logic Behind Connect Button ---
  window.connectToWifi = () => {
    // Empty logic as requested
  };
  
  // Wi-Fi Admin Save (Still works for owner)
  window.saveWifiSettings = async () => {
      const ssid = document.getElementById('wifi-ssid').value;
      const pass = document.getElementById('wifi-pass').value;
      await setDoc(doc(db, "settings", "wifi"), { ssid, pass });
      alert("Saved.");
  };

  // --- Live Interval ---
  setInterval(() => {
    // 1. User Timer (Only if joined)
    if(currentUserData.joinDateISO) {
       const srv = window.getRealSurvival(currentUserData);
       document.getElementById('status-days').innerText = window.formatTime(srv);
    }
    
    // 2. Admin Timers (Only for joined users)
    document.querySelectorAll('.admin-live-srv').forEach(el => {
       const iso = el.dataset.iso;
       if(iso && iso !== "null") {
          const paid = parseFloat(el.dataset.paid);
          const srv = paid - ((new Date() - new Date(iso)) / 86400000);
          el.innerText = window.formatTime(srv);
       }
    });

    // 3. Signal Timers
    document.querySelectorAll('.sig-timer').forEach(async el => {
      let rem = Math.max(0, Math.floor((parseInt(el.dataset.expiry) - Date.now()) / 1000));
      if (rem <= 0) { el.innerText = "Expired"; await deleteDoc(doc(db, "signals", el.dataset.sid)).catch(()=>{}); }
      else el.innerText = rem + "s";
    });
  }, 1000);

  window.login = () => signInWithPopup(auth, provider);
  window.logout = async () => { 
    if(auth.currentUser) await updateDoc(doc(db, "users", auth.currentUser.uid), { isOnline: false }); 
    signOut(auth).then(()=>location.reload()); 
  };
    window.saveProfile = async () => {
    const n = document.getElementById('p-name').value.trim();
    const f = document.getElementById('p-father').value.trim();
    const a = document.getElementById('p-address').value.trim();
    const p = document.getElementById('p-phone').value.trim();

    if (n.length < 6 || f.length < 6 || a.length < 6) return alert("Min 6 chars required for Name, Father & Address");

    await updateDoc(doc(db, "users", auth.currentUser.uid), {
  name: n,
  father: f,
  phone: p,
  address: a,
  history: arrayUnion(
    `User updated Name from ${currentUserData.name} ‚Üí‚Üí to ‚Üí‚Üí ${n} at ${getStamp()}`,
    `User updated Father from ${currentUserData.father} ‚Üí‚Üí to ‚Üí‚Üí ${f} at ${getStamp()}`,
    `User updated Phone from ${currentUserData.phone} ‚Üí‚Üí to ‚Üí‚Üí ${p} at ${getStamp()}`,
    `User updated Address from ${currentUserData.address} ‚Üí‚Üí to ‚Üí‚Üí ${a} at ${getStamp()}`
  )
});
    alert("Profile Saved.");
  };

  window.checkStepOne = () => {
    const n = document.getElementById('p-name').value.trim();
    const p = document.getElementById('p-phone').value.trim();

    if (n.length < 6 || !p) return alert("Name/Phone missing.");

    const otp = Math.floor(100000 + Math.random() * 900000);
    const sid = "otp_" + auth.currentUser.uid;
    
    setDoc(doc(db, "signals", sid), {
        type: 'ADMISSION',
        otp: otp,
        uid: auth.currentUser.uid,
        name: n,
        phone: p,
        timestamp: getStamp(),
        expiresAt: Date.now() + 120000
    });
    
    window.currentJoinOtp = otp;
    document.getElementById('step1').classList.remove('step-active');
    document.getElementById('step2').classList.add('step-active');
  };

  window.verifyJoin = async () => {
    if (document.getElementById('join-otp').value == window.currentJoinOtp) {
        const now = new Date();
        await updateDoc(doc(db, "users", auth.currentUser.uid), {
            joinDate: now.toLocaleDateString('en-GB'),
            joinDateISO: now.toISOString(),
            history: arrayUnion(`Joined Library on ${getStamp()}`)
        });
        await deleteDoc(doc(db, "signals", "otp_" + auth.currentUser.uid));
        location.reload();
    } else alert("Invalid OTP");
  };

  window.checkLeaveFees = () => {
    const srv = window.getRealSurvival(currentUserData);
    if (srv < 0) {
        document.getElementById('leave-error-box').classList.remove('hidden');
        document.getElementById('leave-error-msg').innerText = `Dues: Pay ${Math.abs(Math.floor(srv))} days first.`;
        return;
    }
    const otp = Math.floor(100000 + Math.random() * 900000);
    setDoc(doc(db, "signals", "leave_" + auth.currentUser.uid), {
        type: 'EXIT',
        otp: otp,
        uid: auth.currentUser.uid,
        name: currentUserData.name,
        phone: currentUserData.phone,
        timestamp: getStamp(),
        expiresAt: Date.now() + 120000
    });
    window.currentLeaveOtp = otp;
    document.getElementById('lstep1').classList.remove('step-active');
    document.getElementById('lstep2').classList.add('step-active');
  };

  window.verifyLeave = async () => {
    if (document.getElementById('leave-otp').value == window.currentLeaveOtp) {
        // Stop timer by removing joinDateISO, but keep totalPaidDays (Static Balance)
        const lastBal = window.getRealSurvival(currentUserData);

await updateDoc(doc(db, "users", auth.currentUser.uid), {
  totalPaidDays: lastBal,
  joinDateISO: null,
  history: arrayUnion(
    `Left Library on ${getStamp()}`,
    `Membership Left. Last Balance: ${Math.floor(lastBal)} days`
  )
});
        await deleteDoc(doc(db, "signals", "leave_" + auth.currentUser.uid));
        location.reload();
    } else alert("Invalid OTP");
  };
    // --- Admin Logic ---
  window.loadAdmin = () => {
    // 1. Signals (Reverted Payment Layout)
    onSnapshot(collection(db, "signals"), s => {
      let h = ""; 
      s.forEach(d => {
        const sig = d.data();
        if(sig.type !== 'PAYMENT') {
            h += `<div class="card" style="background:#1a1a1a; color:white; border-left:4px solid var(--yellow);">` +
                 `<span class="sig-timer" data-sid="${d.id}" data-expiry="${sig.expiresAt}">--s</span>üì° <b>${sig.type}</b><br>` +
                 `${sig.name}<br>` +
                 `<span style="color:var(--green); font-size:12px;">üìû ${sig.phone}</span><br>` +
                 `<span style="color:#888; font-size:10px;">${sig.timestamp}</span><br>` +
                 `OTP: <span style="color:var(--yellow); font-size:18px; font-weight:bold;">${sig.otp}</span>` +
                 `<button class="btn btn-outline" style="margin-top:10px; padding:8px;" onclick="deleteDoc(doc(db,'signals','${d.id}'))">CLEAR</button></div>`;
        } else {
            // Reverted to Base Code Monospace Layout
            h += `<div class="card" style="white-space: pre-wrap; font-family:monospace; background:#000; color:#0f0; border:1px solid #333; font-size:12px;">` +
            `[PAYMENT SIGNAL]\n--------------------------\nNAME   : ${sig.name}\nPHONE  : ${sig.phone}\nSHIFT  : ${sig.shift}\nDAYS   : ${sig.days}\nAMOUNT : ‚Çπ${sig.amt} (${getStamp()})\n--------------------------\n` + 
            `<div style="display:flex; gap:10px;"><button class="btn btn-green" onclick="handlePay('${d.id}','${sig.uid}','OK',${sig.days},${sig.amt},'${sig.reqT}','${sig.shift}', ${sig.id})">VERIFY</button>` +
            `<button class="btn btn-outline" onclick="handlePay('${d.id}','${sig.uid}','REJ',0,0,'','', ${sig.id})">REJECT</button></div></div>`;
        }
      });
      document.getElementById('admin-otp-list').innerHTML = h || "No active signals.";
    });

    // 2. Survival List (Fixed Logic & Better UI)
    onSnapshot(collection(db, "users"), s => {
      const g = {
  onJ_ok: "",   // Online + Joined + Active/Grace
  onJ_exp: "",  // Online + Joined + Expired
  offJ: "",
  onNL: "",
  offNL: ""
};
      
      s.forEach(d => {
        const u = d.data(); 
        const srv = window.getRealSurvival(u);
        const isJoined = !!u.joinDateISO; // True if joined
        const isOnline = !!u.isOnline;    // True if online
        
        // Counter: Live class only if joined. Static text if left.
        const counterHtml = isJoined 
            ? `<span class="admin-live-srv" data-iso="${u.joinDateISO}" data-paid="${u.totalPaidDays}" style="color:${srv>=0?'var(--green)':'var(--red)'}; font-weight:bold;">${window.formatTime(srv)}</span>` 
            : `<span style="color:#666; font-weight:bold;">${window.formatTime(srv)} (Static)</span>`;

        const card = `
          <div class="player-card" onclick="window.openUser('${d.id}')">
            <div class="player-header">
                <div class="player-info">
                    <img src="${u.photo||''}" class="player-photo">
                    <div>
                        <div style="font-weight:bold; font-size:14px;">${u.name}</div>
                        <div class="status-badge" style="background:${isOnline?'#e8f5e9':'#ffebee'}; color:${isOnline?'green':'red'};">
                            ${isOnline ? '‚óè Online' : '‚óã Offline'}
                        </div>
                    </div>
                </div>
                ${counterHtml}
            </div>
            <div class="player-details">
                <span>üìû ${u.phone || 'N/A'}</span>
                <span>üìß ${u.email || 'N/A'}</span>
            </div>
          </div>`;

        // Strictly categorized buckets (with grace logic)
if (isOnline && isJoined) {
  if (srv >= -28) g.onJ_ok += card;   // üü¢ Active / Grace
  else g.onJ_exp += card;             // üî¥ Expired
}
else if (!isOnline && isJoined) g.offJ += card;
else if (isOnline && !isJoined) g.onNL += card;
else g.offNL += card;
      });

      document.getElementById('admin-survival-list').innerHTML = 
  `<div class="detail-label">üü¢ Online & Joined (Active / Grace)</div>${g.onJ_ok || ""}` +
  `<div class="detail-label">üî¥ Online & Joined (Expired)</div>${g.onJ_exp || ""}` +
  `<div class="detail-label">‚ö™ Offline & Joined</div>${g.offJ || ""}` +
  `<div class="detail-label">üîµ Online (Not Joined)</div>${g.onNL || ""}` +
  `<div class="detail-label">‚ö´ Offline (Not Joined)</div>${g.offNL || ""}`;
    });
  };

  // --- Utilities ---
  window.openUser = async (uid) => {
    const snap = await getDoc(doc(db, "users", uid));
    if(!snap.exists()) return;
    const u = snap.data();
    
    document.getElementById('folder-content').innerHTML = `
      <div class="card" style="text-align:center;">
        <img src="${u.photo||''}" style="width:70px; height:70px; border-radius:50%; margin-bottom:10px;">
        <div class="admin-live-srv live-srv-display" data-iso="${u.joinDateISO}" data-paid="${u.totalPaidDays}">${window.formatTime(window.getRealSurvival(u))}</div>
      </div>
      <div class="card">
        <p><b>Name:</b> ${u.name}</p>
        <p><b>Father:</b> ${u.father || '-'}</p>
        <p><b>Mobile:</b> ${u.phone || '-'}</p>
        <p><b>Email:</b> ${u.email || '-'}</p>
        <p><b>Address:</b> ${u.address || '-'}</p>
      </div>
      <div class="card">
        <label class="detail-label">Manual Adjustment</label>
        <div style="display:flex; gap:5px;"><input type="number" id="adm-manual-days" placeholder="+/- days" style="flex:1; padding:10px;"><button class="btn btn-blue" onclick="window.adminEditDays('${uid}')">Set</button></div>
      </div>
      <div class="card"><div class="log-container" onclick="this.classList.toggle('expanded')">${window.renderLogs(u.history)}</div></div>
      <button class="btn btn-outline" onclick="window.adminForceLeave('${uid}')">FORCE EXIT</button>
    `;
    document.getElementById('owner-folder-view').classList.add('show');
  };

  window.adminForceLeave = async (uid) => {
    if(confirm("Force Stop Session?")){
        const snap = await getDoc(doc(db, "users", uid));
        await updateDoc(doc(db, "users", uid), {
            totalPaidDays: window.getRealSurvival(snap.data()),
            joinDateISO: null,
            history: arrayUnion(`Force Exit by Admin at ${getStamp()}`)
        });
        document.getElementById('owner-folder-view').classList.remove('show');
    }
  };

  window.adminEditDays = async (uid) => {
    const val = parseFloat(document.getElementById('adm-manual-days').value);
    await updateDoc(doc(db, "users", uid), { totalPaidDays: (await getDoc(doc(db,"users",uid))).data().totalPaidDays + val });
    window.openUser(uid);
  };
  
  // Payment Handlers
  window.doPayment = async () => {
    let d = parseInt(document.getElementById('p-days').value), s = document.getElementById('p-shift').value, amt = Math.round((s/28)*d);
    let payId = Date.now(), shiftName = document.getElementById('p-shift').options[document.getElementById('p-shift').selectedIndex].text;
    await setDoc(doc(db, "signals", `pay_${auth.currentUser.uid}_${payId}`), { uid: auth.currentUser.uid, name: currentUserData.name, phone: currentUserData.phone, type: 'PAYMENT', id: payId, reqT: getStamp(), shift: shiftName, days: d, amt: amt, status: 'Pending' });
    await updateDoc(doc(db, "users", auth.currentUser.uid), { history: arrayUnion({ id: payId, reqT: getStamp(), shift: shiftName, days: d, amt: amt, status: 'Pending' }) });
    window.location.href = `upi://pay?pa=7500159996@ptsbi&pn=Library&am=${amt}&cu=INR`;
    document.getElementById('pay-modal').style.display = 'flex';
  };

  window.handlePay = async (sid, uid, stat, days, amt, reqT, shift, payId) => {
  const ref = doc(db, "users", uid);
  const snap = await getDoc(ref);
  if (!snap.exists()) return;

  const u = snap.data();
  const prevBalance = u.totalPaidDays || 0;
  const newBalance = stat === 'OK' ? prevBalance + days : prevBalance;

  const newHistory = u.history.map(h => {
    if (h.id !== payId) return h;

    return {
      ...h,
      status: stat === 'OK' ? 'Verified' : 'Rejected',
      actionT: getStamp(),
      finalNet: newBalance
    };
  });

  await updateDoc(ref, {
    totalPaidDays: newBalance,
    history: newHistory
  });

  await deleteDoc(doc(db, "signals", sid));
};
  
  // Toggles
  window.switchMain = (t) => { document.querySelectorAll('section').forEach(s => s.classList.remove('active')); document.getElementById(t).classList.add('active'); document.querySelectorAll('#main-nav button').forEach(b => b.classList.remove('active')); document.getElementById(t === 'account' ? 'tab-acc' : 'tab-man').classList.add('active'); };
  window.switchAdmin = (t) => { ['otp', 'user', 'wifi'].forEach(k => { document.getElementById('am-pane-'+k).classList.toggle('hidden', k !== t); document.getElementById('am-'+k+'-btn').classList.toggle('active', k === t); }); };
  window.openWizard = () => document.getElementById('joinWizard').classList.add('show');
  window.closeWizard = () => { document.getElementById('joinWizard').classList.remove('show'); document.getElementById('step1').classList.add('step-active'); document.getElementById('step2').classList.remove('step-active'); };
  window.openLeaveWizard = () => document.getElementById('leaveWizard').classList.add('show');
  window.closeLeaveWizard = () => { document.getElementById('leaveWizard').classList.remove('show'); document.getElementById('lstep1').classList.add('step-active'); document.getElementById('lstep2').classList.remove('step-active'); };
  window.makeEdit = (id) => { document.getElementById(id).readOnly = false; document.getElementById(id).focus(); };
  window.calcTotal = () => {
  const daysInput = document.getElementById('p-days');
  if (daysInput.value > 364) daysInput.value = 364;
  if (daysInput.value < 1) daysInput.value = 1;

  const total = Math.round(
    (document.getElementById('p-shift').value / 28) * daysInput.value
  );
  document.getElementById('pay-summary').innerText = `Total: ‚Çπ${total}`;
};
  window.updateUserPhoto = (i) => { if(i.files[0]) { let r=new FileReader(); r.onload=(e)=>updateDoc(doc(db,"users",auth.currentUser.uid),{photo:e.target.result}); r.readAsDataURL(i.files[0]); }};
</script>
</body>
</html>