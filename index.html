<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Library Account Portal</title>
  
  <style>
    /* CSS for Clean Account View */
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f0f2f5; color: #1c1e21; }
    header { background: #1976d2; color: white; padding: 18px; text-align: center; font-weight: bold; }
    .container { padding: 16px; max-width: 500px; margin: auto; }
    .card { background: white; padding: 20px; margin-bottom: 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .hidden { display: none !important; }
    
    input, select { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    label { font-size: 11px; color: #1976d2; font-weight: bold; display: block; margin-top: 12px; }
    
    button.primary { width: 100%; padding: 14px; background: #1976d2; color: white; border: none; border-radius: 8px; margin-top: 16px; font-weight: bold; cursor: pointer; }
    .status-display { font-size: 28px; font-weight: bold; margin: 10px 0; }
  </style>
</head>
<body>

<header>Student Account Portal</header>

<div class="container">
  
  <div id="loginView" class="card" style="text-align:center;">
    <h3>Welcome Student</h3>
    <p>Please sign in to manage your library seat.</p>
    <button class="primary" onclick="window.login()">Sign in with Google</button>
  </div>

  <div id="userProfile" class="hidden">
    
    <div class="card" style="text-align:center;">
      <img id="userImg" src="" style="width: 80px; border-radius: 50%; border: 2px solid #1976d2;">
      <h2 id="userNameHeader" style="margin: 10px 0 5px 0;"></h2>
      <div id="countdownText" class="status-display">--</div>
      <p id="joiningDateText" style="color:gray; font-size:12px;"></p>
    </div>
    
    <div class="card">
      <h3>Personal Records</h3>
      <label>Student Full Name</label>
      <input type="text" id="name" placeholder="Enter Name">
      
      <label>Father's Name</label>
      <input type="text" id="father" placeholder="Enter Father's Name">
      
      <label>Date of Birth</label>
      <input type="date" id="dob">
      
      <label>Mobile Number</label>
      <input type="tel" id="phone" placeholder="7500XXXXXX">
      
      <button class="primary" style="background:#27ae60;" onclick="window.updateProfile()">Update Student Folder</button>
    </div>

    <div id="joinBox" class="card">
      <h3>Library Admission</h3>
      <p style="font-size: 14px; color: #65676b;">Click below to request a seat. You must get the verification code from the owner.</p>
      <button class="primary" onclick="window.requestJoin()">Request Seat OTP</button>
      
      <div id="otpInputArea" class="hidden">
        <label style="color:red;">Enter Code Provided by Owner</label>
        <input type="number" id="otpInput" placeholder="000000">
        <button class="primary" onclick="window.verifyAdmission()">Verify & Lock Admission</button>
      </div>
    </div>

    <div id="paymentBox" class="card hidden">
      <h3>Fees & Renewal</h3>
      <label>Select Shift</label>
      <select id="shiftSelect">
        <option value="500">Day Shift (₹500)</option>
        <option value="400">Night Shift (₹400)</option>
        <option value="800">Full 24h Shift (₹800)</option>
      </select>
      
      <label>Days to Add</label>
      <input type="number" id="payDays" value="28">
      
      <button class="primary" onclick="window.processPayment()">Pay Fee via UPI</button>
      <p style="font-size: 11px; text-align: center; color: gray; margin-top: 10px;">Payment will be sent to owner: 7500159996</p>
    </div>

    <button style="color:red; background:none; border:none; width:100%; margin-top:10px; cursor:pointer;" onclick="window.logout()">Logout Account</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = { 
    apiKey: "AIzaSyDjn6u195jqewM53qb2xnrPruFnMOELAcc", 
    authDomain: "rakshapal-singh-library-ded2e.firebaseapp.com", 
    projectId: "rakshapal-singh-library-ded2e", 
    storageBucket: "rakshapal-singh-library-ded2e.firebasestorage.app", 
    messagingSenderId: "988319651464", 
    appId: "1:988319651464:web:477fa283cddb1d1123713d" 
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  window.login = () => signInWithPopup(auth, provider);
  window.logout = () => signOut(auth).then(() => location.reload());

  // Logic to calculate days remaining
  function getDaysRem(isoJoin, paid) {
    if(!isoJoin) return 0;
    const diff = Math.floor((new Date() - new Date(isoJoin)) / (1000 * 60 * 60 * 24));
    return (paid || 0) - diff;
  }

  onAuthStateChanged(auth, (user) => {
    if(user) {
      document.getElementById('loginView').classList.add('hidden');
      document.getElementById('userProfile').classList.remove('hidden');
      document.getElementById('userImg').src = user.photoURL;
      document.getElementById('userNameHeader').innerText = user.displayName;

      // Real-time listener for student data
      onSnapshot(doc(db, "users", user.uid), (snap) => {
        if(snap.exists()) {
          const d = snap.data();
          document.getElementById('name').value = d.name || "";
          document.getElementById('father').value = d.father || "";
          document.getElementById('dob').value = d.dob || "";
          document.getElementById('phone').value = d.phone || "";
          
          if(d.joinDateISO) {
            document.getElementById('joinBox').classList.add('hidden');
            document.getElementById('paymentBox').classList.remove('hidden');
            document.getElementById('joiningDateText').innerText = "Joined: " + d.joinDate;
            
            const rem = getDaysRem(d.joinDateISO, d.totalPaidDays);
            const countEl = document.getElementById('countdownText');
            countEl.innerText = Math.abs(rem) + " Days";
            countEl.style.color = rem >= 0 ? "#2ecc71" : "#e74c3c";
          }
        }
      });
    }
  });

  // Function to save profile data
  window.updateProfile = () => {
    setDoc(doc(db, "users", auth.currentUser.uid), {
      name: document.getElementById('name').value, 
      father: document.getElementById('father').value,
      dob: document.getElementById('dob').value, 
      phone: document.getElementById('phone').value,
      photo: auth.currentUser.photoURL
    }, {merge: true}).then(() => alert("Profile folder updated in database."));
  };

  // Function to send joining signal to owner
  window.requestJoin = () => {
    const otp = Math.floor(100000 + Math.random() * 900000);
    setDoc(doc(db, "signals", auth.currentUser.uid), { 
      otp, 
      name: document.getElementById('name').value || auth.currentUser.displayName 
    }).then(() => {
      document.getElementById('otpInputArea').classList.remove('hidden');
      alert("Request sent! Ask the owner (7500159996) for your verification code.");
    });
  };

  // Verify OTP and lock the joining date
  window.verifyAdmission = async () => {
    const snap = await getDoc(doc(db, "signals", auth.currentUser.uid));
    if(snap.exists() && snap.data().otp == document.getElementById('otpInput').value) {
      const now = new Date();
      await setDoc(doc(db, "users", auth.currentUser.uid), {
        joinDate: now.toLocaleDateString(), 
        joinDateISO: now.toISOString(), 
        totalPaidDays: 0
      }, {merge: true});
      await deleteDoc(doc(db, "signals", auth.currentUser.uid));
      alert("Admission Verified. Welcome to the Library!");
      location.reload();
    } else {
      alert("Invalid code. Please check with the owner.");
    }
  };

  // UPI Payment Logic
  window.processPayment = async () => {
    const amount = document.getElementById('shiftSelect').value;
    const ownerUPI = "7500159996@ptsbi"; // Ensure this is correct
    const upiUrl = `upi://pay?pa=${ownerUPI}&pn=RakshapalLibrary&am=${amount}&cu=INR`;
    
    window.location.href = upiUrl;

    if(confirm("Click OK after you finish the payment in your UPI app.")) {
      const userRef = doc(db, "users", auth.currentUser.uid);
      const snap = await getDoc(userRef);
      await setDoc(userRef, { 
        totalPaidDays: (snap.data().totalPaidDays || 0) + parseInt(document.getElementById('payDays').value) 
      }, { merge: true });
    }
  };
</script>
</body>
</html>
