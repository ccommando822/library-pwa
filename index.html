<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rakshapal Singh Library ERP</title>
  <style>
    :root { --primary: #1976d2; --bg: #f4f7f6; --dark: #1c1e21; --green: #2ecc71; --red: #e74c3c; --black: #000000; --yellow: #f1c40f; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--dark); }
    header { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 18px; }
    nav { display: flex; background: white; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 1000; }
    nav button { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-weight: bold; color: #666; }
    nav button.active { border-bottom: 3px solid var(--primary); color: var(--primary); }
    section { padding: 15px; display: none; max-width: 500px; margin: auto; }
    section.active { display: block; }
    .card { background: white; padding: 20px; margin-bottom: 15px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .detail-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
    .detail-content { flex: 1; }
    .detail-label { font-size: 10px; color: var(--primary); font-weight: bold; text-transform: uppercase; margin-bottom: 5px; display: block; }
    .detail-content input, .detail-content textarea { border: none; background: transparent; font-size: 16px; width: 100%; outline: none; padding: 4px 0; font-family: inherit; }
    .detail-content input:not([readonly]), .detail-content textarea:not([readonly]) { border-bottom: 1.5px solid var(--primary); background: #fffde7; }
    .pencil-btn { cursor: pointer; color: var(--primary); font-size: 18px; padding-left: 10px; }
    .wizard-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; padding: 20px; box-sizing: border-box; display: none; }
    .wizard-overlay.show { display: block; overflow-y: auto; }
    #pay-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:3000; display:none; align-items:center; justify-content:center; }
    .modal-box { background:white; padding:30px; border-radius:15px; width:80%; max-width:350px; text-align:center; }
    .player-card { background: #fff; border-radius: 12px; padding: 12px; display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; border: 1px solid #eee; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
    .player-photo { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; border: 1px solid #ddd; object-fit: cover; }
    .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 15px; margin-top: 10px; }
    .btn-blue { background: var(--primary); color: white; }
    .btn-green { background: var(--green); color: white; }
    .btn-outline { background: transparent; border: 1.5px solid var(--red); color: var(--red); }
    .hidden { display: none !important; }
    .log-container { max-height: 100px; overflow-y: hidden; font-size: 11px; margin-top: 8px; display: flex; flex-direction: column; cursor: pointer; position: relative; }
    .log-container.log-expanded { max-height: none !important; }
    .sig-item { padding: 12px; border-bottom: 1px solid #eee; position: relative; }
    .sig-timer { float: right; color: var(--yellow); font-size: 11px; font-weight: bold; }
  </style>
</head>
<body>

<header>Rakshapal Singh Library</header>

<div id="pay-modal" onclick="this.style.display='none'">
    <div class="modal-box">
        <h3 style="color:var(--primary); margin-top:0;">Payment Initiated</h3>
        <p style="font-size:14px; color:#333;">Owner verification required.</p>
        <p style="font-size:16px; font-weight:bold; color:var(--red);">Call 7500159996</p>
    </div>
</div>

<nav id="main-nav">
  <button id="tab-acc" class="active" onclick="switchMain('account')">Account</button>
  <button id="tab-man" class="hidden" onclick="switchMain('manage')">Manage üõ†</button>
</nav>

<section id="account" class="active">
  <div id="loginPanel" class="card" style="text-align:center;">
    <button class="btn btn-blue" onclick="window.login()">Sign in with Google</button>
  </div>
  <div id="profilePanel" class="hidden">
    <div class="card" style="text-align:center; border-bottom: 4px solid var(--primary);">
      <img id="u-img" style="width:80px; height:80px; border-radius:50%; margin-bottom:10px; cursor:pointer;" onclick="document.getElementById('photo-input').click()">
      <input type="file" id="photo-input" class="hidden" accept="image/*" onchange="window.updateUserPhoto(this)">
      <div id="status-joined" style="font-size: 12px; color: #666; font-weight: bold;">NOT JOINED</div>
      <div id="status-days" style="font-size: 24px; font-weight: 900; color: #ccc;">--</div>
    </div>
    <div class="card">
      <div class="detail-row"><div class="detail-content"><label class="detail-label">Full Name</label><input type="text" id="p-name" readonly></div><span class="pencil-btn" onclick="makeEdit('p-name')">‚úèÔ∏è</span></div>
      <div class="detail-row"><div class="detail-content"><label class="detail-label">Father's Name</label><input type="text" id="p-father" readonly></div><span class="pencil-btn" onclick="makeEdit('p-father')">‚úèÔ∏è</span></div>
      <div class="detail-row"><div class="detail-content"><label class="detail-label">Mobile</label><input type="tel" id="p-phone" readonly></div><span class="pencil-btn" onclick="makeEdit('p-phone')">‚úèÔ∏è</span></div>
      <div class="detail-row"><div class="detail-content"><label class="detail-label">Address</label><textarea id="p-address" readonly rows="2"></textarea></div><span class="pencil-btn" onclick="makeEdit('p-address')">‚úèÔ∏è</span></div>
      <button class="btn btn-green" onclick="window.saveProfile()">Save Details</button>
    </div>
    <div class="card"><label class="detail-label">My Logs</label><div id="user-pay-log" class="log-container" onclick="this.classList.toggle('log-expanded')"></div></div>
    <div id="active-tools" class="hidden">
        <div class="card" style="background: #f0f7ff;">
            <select id="p-shift" onchange="calcTotal()" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px;">
                <option value="500">Day Shift (‚Çπ500)</option>
                <option value="400">Night Shift (‚Çπ400)</option>
                <option value="700">Both Shift (‚Çπ700)</option>
            </select>
            <input type="number" id="p-days" value="28" oninput="calcTotal()" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px;">
            <div id="pay-summary" style="font-weight:bold; color:var(--primary);">Total: ‚Çπ500</div>
            <button class="btn btn-blue" onclick="window.doPayment()">Pay Now</button>
        </div>
    </div>
    <button style="width:100%; border:none; color:gray; padding:20px; cursor:pointer;" onclick="window.logout()">Logout</button>
  </div>
</section>

<section id="manage">
    <div style="display:flex; gap:5px; margin-bottom:15px;">
        <button id="am-otp-btn" class="active" onclick="switchAdmin('otp')" style="flex:1; padding:10px; border-radius:8px; border:none;">Signals</button>
        <button id="am-user-btn" onclick="switchAdmin('user')" style="flex:1; padding:10px; border-radius:8px; border:none;">Survivals</button>
    </div>
    <div id="am-pane-otp"><div id="admin-otp-list"></div></div>
    <div id="am-pane-user" class="hidden"><div id="admin-survival-list"></div></div>
</section>

<div id="owner-folder-view" class="wizard-overlay">
    <button class="btn btn-black" onclick="document.getElementById('owner-folder-view').classList.remove('show')">‚Üê Back</button>
    <div id="folder-content"></div>
</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, arrayUnion, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = { apiKey: "AIzaSyDjn6u195jqewM53qb2xnrPruFnMOELAcc", authDomain: "rakshapal-singh-library-ded2e.firebaseapp.com", projectId: "rakshapal-singh-library-ded2e", storageBucket: "rakshapal-singh-library-ded2e.firebasestorage.app", messagingSenderId: "988319651464", appId: "1:988319651464:web:477fa283cddb1d1123713d" };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  let currentUserData = {};
  const getStamp = () => new Date().toLocaleString('en-GB');

  window.renderLogs = (history) => {
    let logs = "";
    (history || []).slice().reverse().forEach(m => {
      if (typeof m === 'string') {
        logs += `<div style="padding:5px 0; border-bottom:1px solid #eee;">${m}</div>`;
      } else {
        const icon = m.status === 'Pending' ? "üí∞" : (m.status === 'Verified' ? "‚úÖ" : "‚ùå");
        logs += `<div style="padding:10px 0; border-bottom:1px solid #eee; white-space:pre-wrap; font-size:12px;">` +
        `${icon} ${m.status}: Request at ${m.reqT}\n` +
        `=>shift:-${m.shift}\n=>Days:- ${m.days}\n=>Amount:-‚Çπ${m.amt}\n` +
        (m.status === 'Pending' ? `=> [Status: Pending]` : `=>${m.status} at ${m.actionT}\n=>Net days:- ${Math.floor(m.finalNet)}d`) +
        `</div>`;
      }
    });
    return logs;
  };

  window.getRealSurvival = (u) => {
    if(!u.joinDateISO) return u.totalPaidDays || 0;
    return (u.totalPaidDays || 0) - ((new Date() - new Date(u.joinDateISO)) / 86400000);
  };

  onAuthStateChanged(auth, async (user) => {
    if(user) {
      const uRef = doc(db, "users", user.uid);
      await updateDoc(uRef, { isOnline: true }).catch(async () => {
          await setDoc(uRef, { name: user.displayName, photo: user.photoURL, isOnline: true, totalPaidDays: 0, history: [] });
      });
      onSnapshot(uRef, snap => {
        if(snap.exists()) {
          currentUserData = snap.data();
          document.getElementById('loginPanel').classList.add('hidden');
          document.getElementById('profilePanel').classList.remove('hidden');
          document.getElementById('u-img').src = currentUserData.photo || user.photoURL;
          ['name','father','phone','address'].forEach(k => document.getElementById('p-'+k).value = currentUserData[k] || "");
          if(currentUserData.joinDateISO) {
             document.getElementById('active-tools').classList.remove('hidden');
             const srv = window.getRealSurvival(currentUserData);
             document.getElementById('status-days').innerText = Math.floor(srv) + " Days Left";
             document.getElementById('status-days').style.color = srv >= 0 ? "var(--green)" : "var(--red)";
          }
          document.getElementById('user-pay-log').innerHTML = window.renderLogs(currentUserData.history);
          if(user.email === "c.commando822@gmail.com") {
             document.getElementById('tab-man').classList.remove('hidden');
             window.loadAdmin();
          }
        }
      });
    }
  });

  window.saveProfile = async () => {
    const updates = {};
    ['name','father','phone','address'].forEach(k => updates[k] = document.getElementById('p-'+k).value);
    await updateDoc(doc(db, "users", auth.currentUser.uid), updates);
    alert("Saved.");
  };

  window.login = () => signInWithPopup(auth, provider);
  window.logout = async () => { if(auth.currentUser) await updateDoc(doc(db, "users", auth.currentUser.uid), { isOnline: false }); signOut(auth).then(()=>location.reload()); };
  // --- Navigation ---
  window.switchMain = (t) => {
    localStorage.setItem('activeTab', t);
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.getElementById(t).classList.add('active');
    document.querySelectorAll('#main-nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(t === 'account' ? 'tab-acc' : 'tab-man').classList.add('active');
  };

  window.switchAdmin = (t) => {
    localStorage.setItem('adminTab', t);
    document.getElementById('am-pane-otp').classList.toggle('hidden', t !== 'otp');
    document.getElementById('am-pane-user').classList.toggle('hidden', t !== 'user');
    document.getElementById('am-otp-btn').classList.toggle('active', t === 'otp');
    document.getElementById('am-user-btn').classList.toggle('active', t === 'user');
  };

  // --- Owner Folder View & Management ---
  window.openUser = async (uid) => {
    const uSnap = await getDoc(doc(db, "users", uid));
    if(!uSnap.exists()) return;
    const u = uSnap.data();
    const srv = window.getRealSurvival(u);
    
    document.getElementById('folder-content').innerHTML = `
      <div class="card" style="text-align:center;">
        <img src="${u.photo||''}" style="width:60px; height:60px; border-radius:50%;">
        <div style="font-size:24px; font-weight:900; color:${srv>=0?'var(--green)':'var(--red)'}">${srv.toFixed(2)}d Remaining</div>
      </div>

      <div class="card" style="background:#f0f7ff; border:1px solid var(--primary);">
        <label class="detail-label">Update Days Manually</label>
        <div style="display:flex; gap:10px; margin-top:5px;">
            <input type="number" id="adm-manual-days" placeholder="+/- Days" style="flex:1; padding:10px; border:1px solid #ccc; border-radius:5px;">
            <button class="btn btn-blue" style="width:auto; margin-top:0; padding:10px 20px;" onclick="window.adminEditDays('${uid}')">Update</button>
        </div>
      </div>

      <div class="card">
        <label class="detail-label">Full Profile Details</label>
        <div style="font-size:14px; line-height:1.8; margin-top:10px;">
            <b>Name:</b> ${u.name || '---'}<br>
            <b>Father:</b> ${u.father || '---'}<br>
            <b>DOB:</b> ${u.dob || '---'}<br>
            <b>Phone:</b> ${u.phone || '---'}<br>
            <b>Address:</b> ${u.address || '---'}
        </div>
      </div>
      <div class="card">
        <label class="detail-label">Activity Logs</label>
        <div class="log-container" onclick="this.classList.toggle('log-expanded')">${window.renderLogs(u.history)}</div>
      </div>
      <button class="btn btn-outline" onclick="window.adminForceLeave('${uid}')">Force Membership Exit</button>`;
    document.getElementById('owner-folder-view').classList.add('show');
  };

  window.adminEditDays = async (uid) => {
    const dVal = document.getElementById('adm-manual-days').value;
    if(!dVal) return;
    const daysToAdd = parseInt(dVal);
    const uRef = doc(db, "users", uid);
    const snap = await getDoc(uRef);
    const currentTotal = snap.data().totalPaidDays || 0;
    
    await updateDoc(uRef, { 
        totalPaidDays: currentTotal + daysToAdd,
        history: arrayUnion(`üõ† Admin manually adjusted days by ${daysToAdd > 0 ? '+' : ''}${daysToAdd} at ${getStamp()}`)
    });
    alert("Days updated successfully.");
    window.openUser(uid); // Refresh the view
  };

  window.adminForceLeave = async (uid) => {
    if(confirm("Confirm: Terminate this user's membership?")) {
        const uRef = doc(db, "users", uid);
        const snap = await getDoc(uRef);
        await updateDoc(uRef, { 
            totalPaidDays: window.getRealSurvival(snap.data()), 
            joinDateISO: null, 
            history: arrayUnion(`‚ö†Ô∏è MEMBERSHIP TERMINATED BY OWNER at ${getStamp()}`) 
        });
        document.getElementById('owner-folder-view').classList.remove('show');
    }
  };

  window.handlePay = async (sid, uid, stat, days, amt, reqT, shift, payId) => {
    const ref = doc(db, "users", uid), snap = await getDoc(ref);
    const uData = snap.data();
    const newTotal = stat == 'OK' ? (uData.totalPaidDays || 0) + days : uData.totalPaidDays;
    const newHistory = uData.history.map(item => {
        if(item.id === payId) return { ...item, status: stat == 'OK' ? 'Verified' : 'Rejected', actionT: getStamp(), finalNet: newTotal };
        return item;
    });
    await updateDoc(ref, { totalPaidDays: newTotal, history: newHistory });
    await deleteDoc(doc(db, "signals", sid));
  };

  // --- Main Admin Logic ---
  window.loadAdmin = () => {
    // 1. Signals Listener (Fixed: Now uses white-space: pre-wrap for proper lines)
    onSnapshot(collection(db, "signals"), s => {
      let h = ""; 
      s.forEach(d => {
        const sig = d.data();
        if(sig.type !== 'PAYMENT') {
            const rem = Math.max(0, Math.floor((sig.expiresAt - Date.now())/1000));
            h += `<div class="sig-item" style="background:#1a1a1a; margin-bottom:5px; border-radius:5px; border-left: 3px solid var(--yellow); color:white;">` +
                 `&nbsp;&nbsp; üì° <b>${sig.type}</b> | User: ${sig.name}<br>` +
                 `&nbsp;&nbsp; OTP: <span style="color:var(--yellow); font-size:16px;">${sig.otp}</span> ` +
                 `<span class="sig-timer">${rem}s</span></div>`;
        } else {
            // "white-space: pre-wrap" ensures every \n is treated as a new line
            h += `<div class="sig-item" style="white-space: pre-wrap; font-family:monospace; background:#000; color:#0f0; padding:12px; border:1px solid #333; border-radius:8px; margin-bottom:10px; font-size:12px;">` +
            `[PAYMENT SIGNAL]\n` +
            `--------------------------\n` +
            `NAME   : ${sig.name}\n` +
            `PHONE  : ${sig.phone}\n` +
            `SHIFT  : ${sig.shift}\n` +
            `DAYS   : ${sig.days} Days\n` +
            `AMOUNT : ‚Çπ${sig.amt}\n` +
            `--------------------------\n\n` + 
            `<div style="display:flex; gap:10px;">` +
            `<button class="btn btn-green" style="flex:1; padding:8px;" onclick="handlePay('${d.id}','${sig.uid}','OK',${sig.days},${sig.amt},'${sig.reqT}','${sig.shift}', ${sig.id})">VERIFY</button>` +
            `<button class="btn btn-outline" style="flex:1; padding:8px;" onclick="handlePay('${d.id}','${sig.uid}','REJ',${sig.days},${sig.amt},'${sig.reqT}','${sig.shift}', ${sig.id})">REJECT</button>` +
            `</div></div>`;
        }
      });
      document.getElementById('admin-otp-list').innerHTML = h || "No active signals.";
    });

    // 2. Survivability Categorization Listener
    onSnapshot(collection(db, "users"), s => {
      const g = { onJ: "", offJ: "", onNL: "", offNL: "" };
      s.forEach(d => {
        const u = d.data(); const srv = window.getRealSurvival(u);
        const dayVal = Math.floor(srv);
        const statusColor = srv >= 0 ? 'var(--green)' : 'var(--red)';
        const statusText = srv >= 0 ? `${dayVal}d Left` : `Expired (${Math.abs(dayVal)}d)`;

        const card = `
          <div class="player-card" onclick="window.openUser('${d.id}')">
            <div style="display:flex; align-items:center;">
                <img src="${u.photo||''}" class="player-photo">
                <div><b style="font-size:14px;">${u.name}</b><br><span style="font-size:10px; color:#aaa;">${u.isOnline ? '‚óè Online' : '‚óã Offline'}</span></div>
            </div>
            <div style="text-align:right;"><span style="font-size:12px; font-weight:bold; color:${statusColor}">${statusText}</span></div>
          </div>`;
        
        if(u.isOnline) { u.joinDateISO ? g.onJ += card : g.onNL += card; } 
        else { u.joinDateISO ? g.offJ += card : g.offNL += card; }
      });
      document.getElementById('admin-survival-list').innerHTML = `
        <div class="detail-label">üü¢ Online Joined</div>${g.onJ || '<div style="color:gray; padding:10px; font-size:11px;">Empty</div>'}
        <div class="detail-label">‚ö™ Offline Joined</div>${g.offJ || '<div style="color:gray; padding:10px; font-size:11px;">Empty</div>'}
        <div class="detail-label">üîµ Online New/Left</div>${g.onNL || '<div style="color:gray; padding:10px; font-size:11px;">Empty</div>'}
        <div class="detail-label">‚ö´ Offline New/Left</div>${g.offNL || '<div style="color:gray; padding:10px; font-size:11px;">Empty</div>'}`;
    });
  };

  // --- Helper Wizards ---
  window.updateUserPhoto = (input) => { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = async (e) => { await updateDoc(doc(db, "users", auth.currentUser.uid), { photo: e.target.result }); }; reader.readAsDataURL(input.files[0]); } };
  window.openWizard = () => document.getElementById('joinWizard').classList.add('show');
  window.closeWizard = () => document.getElementById('joinWizard').classList.remove('show');
  window.openLeaveWizard = () => document.getElementById('leaveWizard').classList.add('show');
  window.closeLeaveWizard = () => document.getElementById('leaveWizard').classList.remove('show');
</script>
</body>
</html>
