<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rakshapal Singh Library</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json" />
  <style>
    body { margin: 0; font-family: sans-serif; background: #f4f6f8; color: #333; }
    header { background: #1976d2; color: white; padding: 15px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 100; }
    nav { display: flex; background: white; border-bottom: 1px solid #ddd; position: sticky; top: 50px; z-index: 99; }
    nav button { flex: 1; padding: 12px; border: none; background: none; cursor: pointer; font-size: 13px; }
    nav button.active { border-bottom: 3px solid #1976d2; color: #1976d2; font-weight: bold; }
    section { padding: 15px; display: none; }
    section.active { display: block; }
    .card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .hidden { display: none !important; }
    button.primary { width: 100%; padding: 12px; background: #1976d2; color: white; border: none; border-radius: 4px; margin-top: 10px; font-weight: bold; cursor: pointer; }
    button.danger { width: 100%; padding: 12px; background: #d32f2f; color: white; border: none; border-radius: 4px; margin-top: 10px; cursor: pointer; }
    input, select { width: 100%; padding: 10px; margin-top: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    label { font-size: 11px; color: #1976d2; font-weight: bold; display: block; margin-top: 10px; text-transform: uppercase; }
    .otp-box { background: #fffde7; padding: 10px; border: 1px dashed #fbc02d; text-align: center; margin-top: 10px; }
    .history-item { font-size: 12px; padding: 8px; border-bottom: 1px solid #eee; }
    .admin-subnav { display: flex; gap: 10px; margin-bottom: 15px; }
    .admin-subnav button { flex: 1; padding: 8px; font-size: 12px; background: #eee; border: 1px solid #ddd; border-radius: 4px; }
    .admin-subnav button.active { background: #1976d2; color: white; }
  </style>
</head>
<body>

<header>üìö Rakshapal Singh Library</header>

<nav>
  <button id="tab-home" class="active" onclick="window.openTab('home')">Home</button>
  <button id="tab-owner" onclick="window.openTab('owner')">Owner</button>
  <button id="tab-account" onclick="window.openTab('account')">Account</button>
  <button id="tab-admin" class="hidden" onclick="window.openTab('admin')">Manage üõ†</button>
</nav>

<section id="home" class="active">
  <div class="card"><h3>Digital Library System</h3><p>Secure OTP-based entry and automated history tracking.</p></div>
</section>

<section id="owner">
  <div class="card"><h3>Contact Rakshapal Singh</h3><a href="tel:7500159996" style="color: #1976d2; text-decoration: none; font-weight: bold;">üìû 7500159996</a></div>
</section>

<section id="account">
  <div id="publicView" class="card" style="text-align:center">
    <button class="primary" onclick="window.login()">Sign in with Google</button>
  </div>

  <div id="userView" class="hidden">
    <div class="card center">
      <img id="userImg" src="" style="width: 60px; border-radius: 50%;">
      <p id="displayUserStatus" style="font-weight:bold; color:#1976d2"></p>
    </div>

    <div class="card">
      <label>Full Name</label><input type="text" id="profName">
      <label>Father's Name</label><input type="text" id="profFather">
      <label>Mobile Number</label><input type="tel" id="profPhone">
      <button class="primary" style="background: #4caf50;" onclick="window.saveProfile()">Update Details</button>
    </div>

    <div id="historyCard" class="card hidden">
      <h3>Your Payment History</h3>
      <div id="userHistoryList"></div>
    </div>

    <div id="joinSection" class="card">
      <h3>Request Membership</h3>
      <select id="shift" onchange="window.calculate()"><option value="500">Day</option><option value="400">Night</option><option value="700">Both</option></select>
      <input type="number" id="days" value="28" oninput="window.calculate()">
      <p><b>Total: ‚Çπ<span id="total">500</span></b></p>
      <button class="primary" onclick="window.payAndRequest()">Pay & Get Code</button>
      
      <div id="joinOtpArea" class="hidden otp-box">
        <p>Call Owner for OTP</p>
        <input type="number" id="joinOtpInput" placeholder="6-digit Code">
        <button class="primary" onclick="window.verifyOtp('JOIN')">Verify & Join</button>
      </div>
    </div>

    <div id="memberSection" class="hidden">
       <div class="card" style="border-top: 5px solid #4caf50;">
         <h3 style="color: green;">Member Panel</h3>
         <button class="danger" onclick="window.initiateLeave()">Request to Leave</button>
         <div id="leaveOtpArea" class="hidden otp-box">
           <input type="number" id="leaveOtpInput" placeholder="Enter Exit Code">
           <button class="primary" onclick="window.verifyOtp('LEAVE')">Confirm Exit</button>
         </div>
       </div>
    </div>

    <button onclick="window.logout()" style="width:100%; border:none; background:none; color:gray; margin-top:20px;">Logout</button>
  </div>
</section>

<section id="admin">
  <div class="admin-subnav">
    <button id="sub-otp" class="active" onclick="window.switchAdminTab('otp')">Live OTP</button>
    <button id="sub-users" onclick="window.switchAdminTab('users')">User Folders</button>
  </div>

  <div id="admin-otp-view">
    <div class="card"><h3>Active OTP Signals</h3><div id="requestList">No signals.</div></div>
  </div>

  <div id="admin-users-view" class="hidden">
    <div class="card"><h3>Registered Users</h3><div id="userFolderList">Loading...</div></div>
    <div id="folderDetail" class="card hidden">
       <button onclick="document.getElementById('folderDetail').classList.add('hidden')" style="float:right">Close</button>
       <h3 id="detailName">User Folder</h3>
       <div id="detailContent"></div>
    </div>
  </div>
</section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, updateDoc, query, where, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDjn6u195jqewM53qb2xnrPruFnMOELAcc",
    authDomain: "rakshapal-singh-library-ded2e.firebaseapp.com",
    projectId: "rakshapal-singh-library-ded2e",
    storageBucket: "rakshapal-singh-library-ded2e.firebasestorage.app",
    messagingSenderId: "988319651464",
    appId: "1:988319651464:web:477fa283cddb1d1123713d"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  let currentUser = null;

  window.login = () => signInWithPopup(auth, provider);
  window.logout = () => signOut(auth).then(() => location.reload());
  window.openTab = (t) => {
    document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
    document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
    document.getElementById(t).classList.add("active");
    document.getElementById("tab-" + t).classList.add("active");
  };

  window.switchAdminTab = (t) => {
    document.getElementById('admin-otp-view').classList.toggle('hidden', t !== 'otp');
    document.getElementById('admin-users-view').classList.toggle('hidden', t !== 'users');
    document.getElementById('sub-otp').classList.toggle('active', t === 'otp');
    document.getElementById('sub-users').classList.toggle('active', t === 'users');
  };

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById("publicView").classList.add("hidden");
      document.getElementById("userView").classList.remove("hidden");
      document.getElementById("userImg").src = user.photoURL;
      
      const uDoc = await getDoc(doc(db, "users", user.uid));
      if (uDoc.exists()) {
        const d = uDoc.data();
        document.getElementById("profName").value = d.name || user.displayName;
        document.getElementById("profPhone").value = d.phone || "";
        document.getElementById("profFather").value = d.father || "";
        document.getElementById("displayUserStatus").innerText = d.status || "Visitor";
      }

      if (user.email === 'c.commando822@gmail.com') {
        document.getElementById("tab-admin").classList.remove("hidden");
        listenToRequests();
        listenToUserFolders();
      }
      listenToUserStatus(user.uid);
      listenToPersonalHistory(user.uid);
    }
  });

  window.saveProfile = async () => {
    const oldData = (await getDoc(doc(db, "users", currentUser.uid))).data() || {};
    const newData = {
      name: document.getElementById("profName").value,
      phone: document.getElementById("profPhone").value,
      father: document.getElementById("profFather").value
    };
    await setDoc(doc(db, "users", currentUser.uid), newData, { merge: true });
    
    // Log change history
    await addDoc(collection(db, `users/${currentUser.uid}/logs`), {
      old: oldData,
      new: newData,
      time: new Date().toLocaleString()
    });
    alert("Profile Updated!");
  };

  window.payAndRequest = () => {
    const amount = document.getElementById("total").innerText;
    window.location.href = `upi://pay?pa=7500159996@ybl&pn=Rakshapal%20Singh&am=${amount}&cu=INR`;
    setTimeout(() => {
      const txn = prompt("Enter UPI Txn ID:");
      if(txn) {
        sendSignal("JOIN", amount, txn);
        document.getElementById("joinOtpArea").classList.remove("hidden");
      }
    }, 2000);
  };

  window.initiateLeave = () => {
    sendSignal("LEAVE", 0, "N/A");
    document.getElementById("leaveOtpArea").classList.remove("hidden");
  };

  async function sendSignal(type, amount, txn) {
    const otp = Math.floor(100000 + Math.random() * 900000);
    const signalId = currentUser.uid;
    await setDoc(doc(db, "signals", signalId), {
      uid: currentUser.uid,
      name: document.getElementById("profName").value,
      type, amount, txn, otp, time: Date.now()
    });
    
    // AUTO-EXPIRY: Delete after 10 minutes (600,000 ms)
    setTimeout(async () => {
      await deleteDoc(doc(db, "signals", signalId));
    }, 600000);
  }

  window.verifyOtp = async (type) => {
    const input = document.getElementById(type === 'JOIN' ? 'joinOtpInput' : 'leaveOtpInput').value;
    const sDoc = await getDoc(doc(db, "signals", currentUser.uid));
    if (sDoc.exists() && sDoc.data().otp == input) {
      const sData = sDoc.data();
      await setDoc(doc(db, "users", currentUser.uid), { status: (type === 'JOIN' ? 'MEMBER' : 'VISITOR') }, { merge: true });
      
      // Store in Payment/Join History Folder
      await addDoc(collection(db, `users/${currentUser.uid}/history`), {
        type: type,
        amount: sData.amount,
        txn: sData.txn,
        date: new Date().toLocaleString()
      });

      await deleteDoc(doc(db, "signals", currentUser.uid));
      alert("Verification Success!");
      location.reload();
    } else {
      alert("Invalid or Expired Code!");
    }
  };

  // ADMIN: USER FOLDERS
  function listenToUserFolders() {
    onSnapshot(collection(db, "users"), (snap) => {
      let html = "";
      snap.forEach(d => {
        const u = d.data();
        html += `<div class="history-item" onclick="window.viewFolder('${d.id}')" style="cursor:pointer; color:blue">üìÅ ${u.name || 'Unknown'}</div>`;
      });
      document.getElementById("userFolderList").innerHTML = html;
    });
  }

  window.viewFolder = async (uid) => {
    const uDoc = await getDoc(doc(db, "users", uid));
    const history = await getDocs(collection(db, `users/${uid}/history`));
    const logs = await getDocs(collection(db, `users/${uid}/logs`));
    
    document.getElementById('detailName').innerText = uDoc.data().name;
    let html = `<h4>Profile</h4><p>Father: ${uDoc.data().father}<br>Phone: ${uDoc.data().phone}</p><h4>History</h4>`;
    history.forEach(h => {
      html += `<div class='history-item'>${h.data().date} - ${h.data().type} - ‚Çπ${h.data().amount}</div>`;
    });
    html += `<h4>Detail Changes</h4>`;
    logs.forEach(l => {
      html += `<div class='history-item'>${l.data().time}: Updated Details</div>`;
    });
    document.getElementById('detailContent').innerHTML = html;
    document.getElementById('folderDetail').classList.remove('hidden');
  };

  function listenToPersonalHistory(uid) {
    onSnapshot(collection(db, `users/${uid}/history`), (snap) => {
      if(snap.empty) return;
      document.getElementById('historyCard').classList.remove('hidden');
      let html = "";
      snap.forEach(h => {
        html += `<div class="history-item"><b>${h.data().date}</b>: ${h.data().type} (‚Çπ${h.data().amount})</div>`;
      });
      document.getElementById('userHistoryList').innerHTML = html;
    });
  }

  // OTP LISTENING
  function listenToRequests() {
    onSnapshot(collection(db, "signals"), (snap) => {
      let html = "";
      snap.forEach(d => {
        const r = d.data();
        html += `<div class="card" style="border-left:5px solid #fbc02d">
          <p><b>${r.name}</b> requesting <b>${r.type}</b></p>
          <p style="font-size:24px; color:red">CODE: <b>${r.otp}</b></p>
        </div>`;
      });
      document.getElementById("requestList").innerHTML = html || "Waiting for calls...";
    });
  }

  function listenToUserStatus(uid) {
    onSnapshot(doc(db, "users", uid), (d) => {
      const s = d.exists() ? d.data().status : "VISITOR";
      const isMember = s === "MEMBER";
      document.getElementById("joinSection").classList.toggle("hidden", isMember);
      document.getElementById("memberSection").classList.toggle("hidden", !isMember);
    });
  }
</script>
</body>
</html>
