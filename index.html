<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Library ERP</title>
  <style>
    body { margin: 0; font-family: sans-serif; background: #f0f2f5; }
    header { background: #1976d2; color: white; padding: 15px; text-align: center; font-weight: bold; }
    nav { display: flex; background: white; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 1000; }
    nav button { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; }
    nav button.active { border-bottom: 3px solid #1976d2; color: #1976d2; font-weight: bold; }
    section { padding: 15px; display: none; max-width: 500px; margin: auto; }
    section.active { display: block; }
    .card { background: white; padding: 20px; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .hidden { display: none !important; }
    
    /* Edit Pencil Styling */
    .input-row { display: flex; align-items: center; justify-content: space-between; margin-top: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    .input-row input { border: none; background: none; font-size: 16px; width: 80%; color: #333; outline: none; }
    .input-row input:not(:read-only) { background: #fffde7; border-bottom: 1px solid #1976d2; }
    .edit-pencil { cursor: pointer; color: #1976d2; font-size: 18px; }

    button.primary { width: 100%; padding: 12px; background: #1976d2; color: white; border: none; border-radius: 5px; font-weight: bold; margin-top: 10px; }
    
    /* Admin Folder Styling */
    .user-folder { background: #fff; border: 1px solid #ddd; padding: 10px; margin-bottom: 5px; border-radius: 5px; cursor: pointer; }
    .history-box { background: #f9f9f9; padding: 10px; font-size: 12px; margin-top: 10px; border-top: 1px dashed #ccc; }
  </style>
</head>
<body>

<header>Rakshapal Singh Library</header>

<nav>
  <button id="nav-acc" class="active" onclick="showTab('account')">Account</button>
  <button id="nav-man" class="hidden" onclick="showTab('manage')">Manage üõ†</button>
</nav>

<section id="account" class="active">
  <div id="loginView" class="card" style="text-align:center;">
    <button class="primary" onclick="window.login()">Sign in with Google</button>
  </div>

  <div id="userProfile" class="hidden">
    <div class="card" style="text-align:center;">
      <img id="userImg" style="width:70px; border-radius:50%;">
      <div id="countdownText" style="font-size:24px; font-weight:bold; margin-top:10px;">-- Days</div>
    </div>

    <div class="card">
      <h3>Student Details</h3>
      <div class="input-row">
        <input type="text" id="name" readonly placeholder="Name">
        <span class="edit-pencil" onclick="enableEdit('name')">‚úèÔ∏è</span>
      </div>
      <div class="input-row">
        <input type="text" id="father" readonly placeholder="Father's Name">
        <span class="edit-pencil" onclick="enableEdit('father')">‚úèÔ∏è</span>
      </div>
      <div class="input-row">
        <input type="tel" id="phone" readonly placeholder="Mobile (Mandatory)">
        <span class="edit-pencil" onclick="enableEdit('phone')">‚úèÔ∏è</span>
      </div>
      <button class="primary" style="background:#27ae60;" onclick="window.updateProfile()">Save Changes</button>
    </div>

    <div id="joinBox" class="card">
      <button class="primary" onclick="window.requestJoin()">Request Admission OTP</button>
      <div id="otpInputArea" class="hidden">
        <input type="number" id="otpInput" placeholder="Enter OTP">
        <button class="primary" onclick="window.verifyAdmission()">Verify Admission</button>
      </div>
    </div>

    <div id="paymentBox" class="card hidden">
      <select id="shift"><option value="500">Day (‚Çπ500)</option><option value="400">Night (‚Çπ400)</option></select>
      <button class="primary" onclick="window.processPayment()">Pay & Add 28 Days</button>
      <button onclick="window.leaveLibrary()" style="background:none; border:none; color:red; width:100%; margin-top:20px; cursor:pointer;">Leave Library</button>
    </div>
  </div>
</section>

<section id="manage">
  <div class="card" style="background:#000; color:#0f0;">
    <h4>OTP Monitor</h4>
    <div id="otpList"></div>
  </div>
  <div class="card">
    <h4>Student Database (Click to open folder)</h4>
    <div id="folderList"></div>
  </div>
</section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = { apiKey: "AIzaSyDjn6u195jqewM53qb2xnrPruFnMOELAcc", authDomain: "rakshapal-singh-library-ded2e.firebaseapp.com", projectId: "rakshapal-singh-library-ded2e", storageBucket: "rakshapal-singh-library-ded2e.firebasestorage.app", messagingSenderId: "988319651464", appId: "1:988319651464:web:477fa283cddb1d1123713d" };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  window.showTab = (t) => {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.getElementById(t).classList.add('active');
  };

  window.enableEdit = (id) => { document.getElementById(id).readOnly = false; document.getElementById(id).focus(); };

  window.login = () => signInWithPopup(auth, provider);
  window.logout = () => signOut(auth).then(() => location.reload());

  onAuthStateChanged(auth, (user) => {
    if(user) {
      document.getElementById('loginView').classList.add('hidden');
      document.getElementById('userProfile').classList.remove('hidden');
      document.getElementById('userImg').src = user.photoURL;

      onSnapshot(doc(db, "users", user.uid), (snap) => {
        if(snap.exists()) {
          const d = snap.data();
          document.getElementById('name').value = d.name || "";
          document.getElementById('father').value = d.father || "";
          document.getElementById('phone').value = d.phone || "";
          if(d.joinDateISO) {
            document.getElementById('joinBox').classList.add('hidden');
            document.getElementById('paymentBox').classList.remove('hidden');
            const rem = (d.totalPaidDays || 0) - Math.floor((new Date() - new Date(d.joinDateISO)) / 86400000);
            document.getElementById('countdownText').innerText = Math.abs(rem) + " Days";
            document.getElementById('countdownText').style.color = rem >= 0 ? "green" : "red";
          }
        }
      });

      if(user.email === "c.commando822@gmail.com") {
        document.getElementById('nav-man').classList.remove('hidden');
        loadAdmin();
      }
    }
  });

  window.updateProfile = async () => {
    const data = { name: document.getElementById('name').value, father: document.getElementById('father').value, phone: document.getElementById('phone').value, photo: auth.currentUser.photoURL };
    await setDoc(doc(db, "users", auth.currentUser.uid), { ...data, history: arrayUnion(`Edited on ${new Date().toLocaleString()}`) }, {merge: true});
    document.querySelectorAll('input').forEach(i => i.readOnly = true);
    alert("Profile Updated");
  };

  window.requestJoin = () => {
    if(!document.getElementById('phone').value || document.getElementById('phone').value.length < 10) return alert("Mobile number is mandatory to join!");
    const otp = Math.floor(100000 + Math.random() * 900000);
    setDoc(doc(db, "signals", auth.currentUser.uid), { otp, name: document.getElementById('name').value });
    document.getElementById('otpInputArea').classList.remove('hidden');
  };

  window.verifyAdmission = async () => {
    const snap = await getDoc(doc(db, "signals", auth.currentUser.uid));
    if(snap.exists() && snap.data().otp == document.getElementById('otpInput').value) {
      await setDoc(doc(db, "users", auth.currentUser.uid), { joinDateISO: new Date().toISOString(), totalPaidDays: 0 }, {merge: true});
      await deleteDoc(doc(db, "signals", auth.currentUser.uid));
      location.reload();
    }
  };

  window.processPayment = async () => {
    const amt = document.getElementById('shift').value;
    window.location.href = `upi://pay?pa=7500159996@ptsbi&pn=Library&am=${amt}&cu=INR`;
    if(confirm("Payment Success?")) {
      const userRef = doc(db, "users", auth.currentUser.uid);
      const snap = await getDoc(userRef);
      await setDoc(userRef, { 
        totalPaidDays: (snap.data().totalPaidDays || 0) + 28,
        payHistory: arrayUnion(`Paid ‚Çπ${amt} on ${new Date().toLocaleDateString()}`)
      }, {merge: true});
    }
  };

  window.leaveLibrary = async () => {
    if(confirm("Are you sure you want to leave? This clears your seat.")) {
      await setDoc(doc(db, "users", auth.currentUser.uid), { joinDateISO: null, totalPaidDays: 0 }, {merge: true});
      location.reload();
    }
  };

  function loadAdmin() {
    onSnapshot(collection(db, "signals"), s => {
      let h = ""; s.forEach(d => h += `<p>${d.data().name}: ${d.data().otp}</p>`);
      document.getElementById('otpList').innerHTML = h || "No OTPs";
    });
    onSnapshot(collection(db, "users"), s => {
      let h = ""; s.forEach(d => {
        const u = d.data();
        h += `<div class="user-folder" onclick="this.querySelector('.history-box').classList.toggle('hidden')">
          <b>üìÇ ${u.name}</b> (${u.phone})
          <div class="history-box hidden">
            <strong>Change History:</strong><br>${(u.history || []).join('<br>') || 'No changes'}<br><br>
            <strong>Payment History:</strong><br>${(u.payHistory || []).join('<br>') || 'No payments'}
          </div>
        </div>`;
      });
      document.getElementById('folderList').innerHTML = h;
    });
  }
</script>
</body>
</html>
