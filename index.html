<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rakshapal Singh Library</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json" />
  <style>
    body { margin: 0; font-family: sans-serif; background: #f4f6f8; }
    header { background: #1976d2; color: white; padding: 15px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 100; }
    nav { display: flex; background: white; border-bottom: 1px solid #ddd; position: sticky; top: 50px; z-index: 99; }
    nav button { flex: 1; padding: 12px; border: none; background: none; cursor: pointer; }
    nav button.active { border-bottom: 3px solid #1976d2; color: #1976d2; font-weight: bold; }
    section { padding: 15px; display: none; }
    section.active { display: block; }
    .card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .hidden { display: none; }
    button.primary { width: 100%; padding: 12px; background: #1976d2; color: white; border: none; border-radius: 4px; margin-top: 10px; }
    button.danger { width: 100%; padding: 12px; background: #d32f2f; color: white; border: none; border-radius: 4px; margin-top: 10px; }
    input, select { width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    .admin-badge { background: #ffd700; color: black; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 5px; }
  </style>
</head>
<body>

<header>ðŸ“š Rakshapal Singh Library</header>

<nav>
  <button id="tab-home" class="active" onclick="openTab('home')">Home</button>
  <button id="tab-owner" onclick="openTab('owner')">Owner</button>
  <button id="tab-account" onclick="openTab('account')">Account</button>
  <button id="tab-admin" class="hidden" onclick="openTab('admin')">Manage</button>
</nav>

<section id="home" class="active">
  <div class="card">
    <h3>Welcome</h3>
    <p>A disciplined and peaceful study environment for success.</p>
  </div>
</section>

<section id="owner">
  <div class="card">
    <h3>Library Owner</h3>
    <p><b>Name:</b> Rakshapal Singh</p>
    <p><b>Contact:</b> 7500159996</p>
    <p><b>Email:</b> c.commando822@gmail.com</p>
  </div>
</section>

<section id="account">
  <div id="publicView" class="card">
    <h3>Join the Library</h3>
    <p>Sign in with Google to start your membership.</p>
    <button class="primary" onclick="login()">Sign in with Google</button>
  </div>

  <div id="userView" class="hidden">
    <div class="card" style="text-align: center;">
      <img id="userImg" src="" style="width: 80px; border-radius: 50%;">
      <h3 id="userName"></h3>
      <p id="userEmail"></p>
      <div id="statusLabel" style="font-weight: bold; color: #1976d2;">Visitor</div>
    </div>

    <div id="joinSection" class="card">
      <h3>Join Library</h3>
      <select id="shift" onchange="calc()">
        <option value="500">Day Shift (â‚¹500/28 days)</option>
        <option value="400">Night Shift (â‚¹400/28 days)</option>
        <option value="700">Both Shifts (â‚¹700/28 days)</option>
      </select>
      <input type="number" id="days" placeholder="How many days?" oninput="calc()">
      <p>Total to Pay: <b>â‚¹<span id="total">0</span></b></p>
      <p style="font-size: 12px; color: #666;">Pay to 7500159996 via UPI, then click Request.</p>
      <button class="primary" onclick="requestJoin()">Request to Join</button>
    </div>

    <div id="memberSection" class="hidden">
       <div class="card">
         <h3>Membership Details</h3>
         <p id="membershipInfo"></p>
         <button class="danger" onclick="requestLeave()">Request to Leave</button>
       </div>
    </div>

    <button onclick="logout()" style="background: none; border: none; color: gray; width: 100%; cursor: pointer;">Logout</button>
  </div>
</section>

<section id="admin">
  <div class="card">
    <h3>Admin Dashboard</h3>
    <p>Pending Requests for Approval:</p>
    <div id="requestList">Loading...</div>
  </div>
</section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDjn6u195jqewM53qb2xnrPruFnMOELAcc",
    authDomain: "rakshapal-singh-library-ded2e.firebaseapp.com",
    projectId: "rakshapal-singh-library-ded2e",
    storageBucket: "rakshapal-singh-library-ded2e.firebasestorage.app",
    messagingSenderId: "988319651464",
    appId: "1:988319651464:web:477fa283cddb1d1123713d"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  let currentUser = null;

  window.login = () => signInWithPopup(auth, provider);
  window.logout = () => signOut(auth).then(() => location.reload());

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById("publicView").classList.add("hidden");
      document.getElementById("userView").classList.remove("hidden");
      document.getElementById("userName").innerText = user.displayName;
      document.getElementById("userEmail").innerText = user.email;
      document.getElementById("userImg").src = user.photoURL;

      if (user.email === 'c.commando822@gmail.com') {
        document.getElementById("tab-admin").classList.remove("hidden");
        listenToRequests();
      }
      
      listenToUserStatus(user.uid);
    }
  });

  // Calculate Amount
  window.calc = () => {
    const rate = document.getElementById("shift").value;
    const days = document.getElementById("days").value;
    document.getElementById("total").innerText = Math.round((rate/28) * days);
  };

  // Student: Request Join
  window.requestJoin = async () => {
    const amount = document.getElementById("total").innerText;
    if (amount == 0) return alert("Select days");
    await addDoc(collection(db, "requests"), {
      userId: currentUser.uid,
      userName: currentUser.displayName,
      type: 'JOIN',
      amount: amount,
      status: 'PENDING',
      timestamp: Date.now()
    });
    alert("Request Sent! Now call Owner to approve.");
  };

  // Admin: Listen to Requests
  function listenToRequests() {
    onSnapshot(query(collection(db, "requests"), where("status", "==", "PENDING")), (snap) => {
      let html = "";
      snap.forEach(docSnap => {
        const req = docSnap.data();
        html += `<div class="card" style="border-left: 5px solid gold;">
          <p><b>${req.userName}</b> wants to ${req.type}</p>
          <p>Amount: â‚¹${req.amount || 0}</p>
          <button class="primary" onclick="approveRequest('${docSnap.id}', '${req.userId}', '${req.type}')">Approve</button>
        </div>`;
      });
      document.getElementById("requestList").innerHTML = html || "No pending requests.";
    });
  }

  window.approveRequest = async (reqId, uId, type) => {
    await updateDoc(doc(db, "requests", reqId), { status: 'APPROVED' });
    await setDoc(doc(db, "users", uId), { 
      status: type === 'JOIN' ? 'MEMBER' : 'VISITOR',
      lastUpdate: Date.now()
    }, { merge: true });
    alert("Request Approved!");
  };

  function listenToUserStatus(uid) {
    onSnapshot(doc(db, "users", uid), (docSnap) => {
      if (docSnap.exists() && docSnap.data().status === 'MEMBER') {
        document.getElementById("statusLabel").innerText = "ACTIVE MEMBER âœ…";
        document.getElementById("joinSection").classList.add("hidden");
        document.getElementById("memberSection").classList.remove("hidden");
      } else {
        document.getElementById("statusLabel").innerText = "Visitor";
        document.getElementById("joinSection").classList.remove("hidden");
        document.getElementById("memberSection").classList.add("hidden");
      }
    });
  }

  window.openTab = (tab) => {
    document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
    document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
    document.getElementById(tab).classList.add("active");
    document.getElementById("tab-" + tab).classList.add("active");
  };
</script>
</body>
</html>
