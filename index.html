<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rakshapal Singh Library ERP</title>
  <style>
    :root { --primary: #1976d2; --bg: #f4f7f6; --dark: #1c1e21; --green: #2ecc71; --red: #e74c3c; --black: #000000; --yellow: #f1c40f; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--dark); }
    header { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 18px; }
    nav { display: flex; background: white; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 1000; }
    nav button { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-weight: bold; color: #666; }
    nav button.active { border-bottom: 3px solid var(--primary); color: var(--primary); }
    section { padding: 15px; display: none; max-width: 500px; margin: auto; }
    section.active { display: block; }
    .card { background: white; padding: 20px; margin-bottom: 15px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .detail-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
    .detail-label { font-size: 10px; color: var(--primary); font-weight: bold; text-transform: uppercase; }
    .detail-content input { border: none; background: transparent; font-size: 16px; width: 100%; outline: none; padding: 4px 0; font-family: inherit; }
    .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 15px; margin-top: 10px; transition: 0.3s; }
    .btn-blue { background: var(--primary); color: white; }
    .btn-green { background: var(--green); color: white; }
    .btn-red { background: var(--red); color: white; }
    .hidden { display: none !important; }
    .log-container { max-height: 200px; overflow-y: auto; font-size: 12px; margin-top: 10px; border: 1px solid #ddd; padding: 10px; border-radius: 10px; line-height: 1.5; background: #fff; white-space: pre-wrap; cursor: pointer; }
    .log-expanded { max-height: none !important; }
    .sig-item { padding: 15px; border-bottom: 2px solid #333; position: relative; background: #111; color: #eee; margin-bottom: 10px; border-radius: 8px; }
    .sig-timer { position: absolute; top: 10px; right: 10px; color: var(--yellow); font-weight: bold; font-size: 14px; }
    .sig-detail { margin-left: 20px; margin-top: 8px; color: #bbb; font-size: 13px; line-height: 1.6; }
    .player-card { background: #242526; color: #e4e6eb; border-radius: 12px; padding: 10px; display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; justify-content: space-between; }
    .player-photo { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; object-fit: cover; background: #444; }
    .wizard-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; padding: 20px; box-sizing: border-box; display: none; overflow-y: auto; }
    .wizard-overlay.show { display: block; }
  </style>
</head>
<body>

<header>Rakshapal Singh Library</header>

<nav id="main-nav">
  <button id="tab-acc" class="active" onclick="switchMain('account')">Account</button>
  <button id="tab-man" class="hidden" onclick="switchMain('manage')">Manage üõ†</button>
</nav>

<section id="account" class="active">
  <div id="loginPanel" class="card" style="text-align:center;">
    <p>Welcome. Please Sign In.</p>
    <button class="btn btn-blue" onclick="window.login()">Sign in with Google</button>
  </div>

  <div id="profilePanel" class="hidden">
    <div class="card" style="text-align:center;">
      <img id="u-img" style="width:80px; height:80px; border-radius:50%; background:#eee; cursor:pointer;" onclick="triggerPhoto()">
      <input type="file" id="photo-input" hidden accept="image/*" onchange="uploadPhoto(this)">
      <div id="status-joined" style="font-size:12px; font-weight:bold; margin-top:5px;"></div>
      <div id="status-days" style="font-size:24px; font-weight:900;">--</div>
    </div>

    <div class="card" id="renew-panel">
        <label class="detail-label">Renew Membership</label>
        <select id="p-shift" onchange="calcTotal()" style="width:100%; padding:12px; margin:8px 0;">
            <option value="500">Day (‚Çπ500/28 days)</option>
            <option value="400">Night (‚Çπ400/28 days)</option>
            <option value="700">Both (‚Çπ700/28 days)</option>
        </select>
        <input type="number" id="p-days" value="28" max="364" oninput="calcTotal()" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px;">
        <div id="pay-summary" style="padding:10px; font-weight:bold; color:var(--primary);">Total: ‚Çπ500</div>
        <button class="btn btn-blue" onclick="window.doPayment()">Request Payment</button>
    </div>

    <div class="card">
        <label class="detail-label">Payment Logs (Expand/Collapse)</label>
        <div id="user-pay-log" class="log-container" onclick="this.classList.toggle('log-expanded')"></div>
    </div>

    <div id="user-comments" class="card hidden">
        <label class="detail-label">Owner Messages</label>
        <div id="comm-list-user"></div>
        <div style="display:flex; gap:5px; margin-top:10px;">
            <input type="text" id="user-reply-msg" placeholder="Reply..." style="flex:1; padding:8px;">
            <button class="btn-blue" onclick="sendReply()" style="padding:0 15px; border-radius:8px; border:none;">Send</button>
        </div>
    </div>

    <div id="join-trigger-box"><button class="btn btn-blue" onclick="openWizard()">Join Library</button></div>
    <button style="width:100%; background:none; border:none; color:gray; padding:20px; cursor:pointer;" onclick="window.logout()">Logout</button>
  </div>
</section>

<section id="manage">
    <div class="admin-nav" style="display:flex; gap:5px; margin-bottom:15px;">
        <button id="am-otp-btn" class="active" onclick="switchAdmin('otp')" style="flex:1; padding:10px;">Signals</button>
        <button id="am-user-btn" onclick="switchAdmin('user')" style="flex:1; padding:10px;">Survivals</button>
    </div>
    <div id="am-pane-otp"><div class="card" id="admin-otp-list" style="background:#000; min-height:200px;"></div></div>
    <div id="am-pane-user" class="hidden"><div id="admin-survival-list"></div></div>
</section>

<div id="joinWizard" class="wizard-overlay">
    <h2>Admission</h2>
    <div id="step1" class="card" style="border:2px solid var(--primary);"><p>1. Lock Details</p><button class="btn btn-blue" onclick="window.checkStepOne()">Verify & Get OTP</button></div>
    <div id="step2" class="card" style="opacity:0.5;"><p>2. Enter OTP</p><input type="number" id="join-otp" style="width:100%; padding:10px;"><button class="btn btn-black" onclick="window.verifyJoin()">Join</button></div>
    <button class="btn" onclick="closeWizard()">Cancel</button>
</div>

<div id="owner-folder-view" class="wizard-overlay" style="background:var(--bg);">
    <div style="max-width:500px; margin:auto; padding:15px;">
        <button class="btn btn-blue" onclick="closeOwnerView()">‚Üê Back to List</button>
        <div id="folder-content"></div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc, arrayUnion, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = { apiKey: "AIzaSyDjn6u195jqewM53qb2xnrPruFnMOELAcc", authDomain: "rakshapal-singh-library-ded2e.firebaseapp.com", projectId: "rakshapal-singh-library-ded2e", storageBucket: "rakshapal-singh-library-ded2e.firebasestorage.app", messagingSenderId: "988319651464", appId: "1:988319651464:web:477fa283cddb1d1123713d" };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  let currentUserData = {};
  const getStamp = () => new Date().toLocaleString('en-GB');
  const formatSurv = (days) => {
    const abs = Math.abs(days), d = Math.floor(abs), h = Math.floor((abs - d) * 24);
    return `${days < 0 ? '-' : ''}${d}d ${h}h`;
  };
  const getRealSurvival = (u) => u.joinDateISO ? (u.totalPaidDays || 0) - ((new Date() - new Date(u.joinDateISO)) / 86400000) : (u.totalPaidDays || 0);

  window.switchMain = (t) => {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.getElementById(t).classList.add('active');
    document.querySelectorAll('#main-nav button').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-'+t.substring(0,3)).classList.add('active');
    localStorage.setItem('lastTab', t);
  };

  window.switchAdmin = (t) => {
    document.getElementById('am-pane-otp').classList.toggle('hidden', t !== 'otp');
    document.getElementById('am-pane-user').classList.toggle('hidden', t !== 'user');
    document.getElementById('am-otp-btn').classList.toggle('active', t === 'otp');
    document.getElementById('am-user-btn').classList.toggle('active', t === 'user');
  };

  onAuthStateChanged(auth, async (user) => {
    if(user) {
      document.getElementById('loginPanel').classList.add('hidden');
      document.getElementById('profilePanel').classList.remove('hidden');
      onSnapshot(doc(db, "users", user.uid), (snap) => {
        if(snap.exists()) {
          currentUserData = snap.data();
          document.getElementById('u-img').src = currentUserData.photo || user.photoURL;
          if(currentUserData.joinDateISO) {
            document.getElementById('status-joined').innerText = "JOINED: " + currentUserData.joinDate;
            document.getElementById('status-days').innerText = formatSurv(getRealSurvival(currentUserData));
            document.getElementById('join-trigger-box').classList.add('hidden');
          }
          renderUserLogs(currentUserData.history || []);
          renderUserComments(currentUserData.comments || []);
        }
      });
      if(user.email === "c.commando822@gmail.com") { document.getElementById('tab-man').classList.remove('hidden'); loadAdmin(); }
      switchMain(localStorage.getItem('lastTab') || 'account');
    } else {
      document.getElementById('loginPanel').classList.remove('hidden');
      document.getElementById('profilePanel').classList.add('hidden');
    }
  });

  function renderUserLogs(history) {
    let html = "";
    history.slice().reverse().forEach(log => {
        if(typeof log !== 'object') return;
        let icon = log.status === 'Pending' ? 'üí∞' : (log.status === 'Accepted' ? '‚úÖ' : '‚ùå');
        let statusPart = log.status === 'Pending' ? `[Status: Pending]` : 
                         `${log.status === 'Accepted' ? 'Approved' : 'Rejected'} at ${log.actionTime}.\n=>Net days(updated) :- ${log.netDays} days`;
        
        html += `<div style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:8px;">${icon} ${log.status === 'Pending' ? 'Request' : (log.status === 'Accepted' ? 'Verified' : 'Rejected')}: Request at ${log.requestTime}\n=>shift:- ${log.shift}\n=>Days to buy:- ${log.days} days.\n=>Amount to pay:- ‚Çπ${log.amount}.\n=> ${statusPart}</div>`;
    });
    document.getElementById('user-pay-log').innerHTML = html || "No history.";
  }

  function renderUserComments(comms) {
    const list = document.getElementById('comm-list-user');
    list.innerHTML = "";
    comms.filter(c => c.type === 'shown').forEach(c => {
        list.innerHTML += `<div style="background:#f0f4ff; padding:8px; margin-top:5px; border-radius:5px;"><b>Owner:</b> ${c.text}${c.reply ? '<br><b>Reply:</b> '+c.reply : ''}</div>`;
    });
    if(list.innerHTML) document.getElementById('user-comments').classList.remove('hidden');
  }

  window.doPayment = async () => {
    const d = parseInt(document.getElementById('p-days').value);
    const shift = document.getElementById('p-shift').options[document.getElementById('p-shift').selectedIndex].text;
    const amt = Math.round((document.getElementById('p-shift').value/28)*d);
    const payId = Date.now();
    const payObj = { id: payId, requestTime: getStamp(), shift, days: d, amount: amt, status: 'Pending' };
    await updateDoc(doc(db, "users", auth.currentUser.uid), { history: arrayUnion(payObj) });
    await setDoc(doc(db, "signals", "pay_"+payId), { ...payObj, uid: auth.currentUser.uid, name: currentUserData.name || "User", phone: currentUserData.phone || "N/A", type: 'PAYMENT' });
    alert("Request Sent");
  };

  function loadAdmin() {
    onSnapshot(collection(db, "signals"), s => {
      let h = ""; s.forEach(d => {
        const sig = d.data();
        if(sig.type === 'PAYMENT') {
            h += `<div class="sig-item">üí∞ <b>PAYMENT REQUEST</b><div class="sig-detail">Name: ${sig.name}<br>Phone: ${sig.phone}<br>Shift: ${sig.shift}<br>Days: ${sig.days} | Amount: ‚Çπ${sig.amount}<br>Time: ${sig.requestTime}</div><div style="display:flex; gap:10px; margin-top:10px;"><button class="btn-green" style="flex:1; border:none; padding:10px; border-radius:5px;" onclick="handlePay('${d.id}','${sig.uid}','Accepted',${sig.days},${sig.id})">Accept</button><button class="btn-red" style="flex:1; border:none; padding:10px; border-radius:5px;" onclick="handlePay('${d.id}','${sig.uid}','Rejected',${sig.days},${sig.id})">Reject</button></div></div>`;
        } else {
            const rem = Math.max(0, Math.floor((sig.expiresAt - Date.now())/1000));
            if(rem <= 0) deleteDoc(doc(db, "signals", d.id));
            h += `<div class="sig-item">üîë <b>${sig.type}</b> <span class="sig-timer">${rem}s</span><div class="sig-detail">User: ${sig.name}<br>OTP: ${sig.otp}</div></div>`;
        }
      });
      document.getElementById('admin-otp-list').innerHTML = h || "No signals.";
    });

    onSnapshot(collection(db, "users"), s => {
      let html = ""; s.forEach(d => {
        const u = d.data(); const srv = getRealSurvival(u);
        html += `<div class="player-card" onclick="openUser('${d.id}')"><div><img src="${u.photo||''}" class="player-photo"><b>${u.name||'User'}</b></div><span>${formatSurv(srv)}</span></div>`;
      });
      document.getElementById('admin-survival-list').innerHTML = html;
    });
  }

  window.handlePay = async (docId, uid, status, days, payId) => {
    const uRef = doc(db, "users", uid); const snap = await getDoc(uRef); const data = snap.data();
    const updatedHistory = data.history.map(h => (h.id === payId) ? { ...h, status, actionTime: getStamp(), netDays: status==='Accepted' ? (data.totalPaidDays||0)+days : (data.totalPaidDays||0) } : h);
    await updateDoc(uRef, { history: updatedHistory, totalPaidDays: status==='Accepted' ? (data.totalPaidDays||0)+days : (data.totalPaidDays||0) });
    await deleteDoc(doc(db, "signals", docId));
  };

  window.openUser = async (uid) => {
    const u = (await getDoc(doc(db, "users", uid))).data();
    document.getElementById('folder-content').innerHTML = `
      <div class="card" style="text-align:center;"><img src="${u.photo||''}" style="width:60px; border-radius:50%;"><br><b>${u.name}</b></div>
      <div class="card"><label class="detail-label">Update Days</label><input type="number" id="adm-days" value="${u.totalPaidDays}" style="width:100%; padding:10px;"><button class="btn btn-blue" onclick="updateUserDays('${uid}')">Set Total Days</button></div>
      <div class="card"><label class="detail-label">Add Comment</label><input type="text" id="adm-comm" style="width:100%; padding:10px;"><select id="adm-type" style="width:100%; padding:10px; margin:5px 0;"><option value="hidden">Hidden</option><option value="shown">Shown to User</option></select><button class="btn btn-blue" onclick="addUserComm('${uid}')">Post Comment</button></div>
      <div class="card"><label class="detail-label">Full Profile</label><div>Father: ${u.father}</div><div>Phone: ${u.phone}</div><div>DOB: ${u.dob}</div><div>Address: ${u.address}</div></div>
      <button class="btn btn-red" onclick="forceRemove('${uid}')">FORCE REMOVE FROM LIBRARY</button>`;
    document.getElementById('owner-folder-view').classList.add('show');
  };

  window.updateUserDays = async (uid) => { await updateDoc(doc(db, "users", uid), { totalPaidDays: parseFloat(document.getElementById('adm-days').value) }); alert("Updated"); };
  window.addUserComm = async (uid) => { await updateDoc(doc(db, "users", uid), { comments: arrayUnion({ text: document.getElementById('adm-comm').value, type: document.getElementById('adm-type').value, time: getStamp(), reply: "" }) }); openUser(uid); };
  window.forceRemove = async (uid) => { if(confirm("Force user to leave?")) { await updateDoc(doc(db, "users", uid), { totalPaidDays: 0, joinDateISO: null }); closeOwnerView(); } };
  window.triggerPhoto = () => document.getElementById('photo-input').click();
  window.uploadPhoto = (input) => { const reader = new FileReader(); reader.onload = async (e) => { await updateDoc(doc(db, "users", auth.currentUser.uid), { photo: e.target.result }); }; reader.readAsDataURL(input.files[0]); };
  window.login = () => signInWithPopup(auth, provider);
  window.logout = () => signOut(auth).then(()=>location.reload());
  window.calcTotal = () => { let d = document.getElementById('p-days').value; document.getElementById('pay-summary').innerText = `Total: ‚Çπ${Math.round((document.getElementById('p-shift').value/28)*d)}`; };
  window.openWizard = () => document.getElementById('joinWizard').classList.add('show');
  window.closeWizard = () => document.getElementById('joinWizard').classList.remove('show');
  window.closeOwnerView = () => document.getElementById('owner-folder-view').classList.remove('show');
</script>
</body>
</html>
