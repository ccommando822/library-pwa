<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rakshapal Singh Library</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#1976d2" />

  <link rel="manifest" href="manifest.json" />

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f6f8;
    }

    header {
      background: #1976d2;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    nav {
      display: flex;
      justify-content: space-around;
      background: #ffffff;
      border-bottom: 1px solid #ddd;
      position: sticky;
      top: 54px;
      z-index: 99;
    }

    nav button {
      flex: 1;
      padding: 12px;
      border: none;
      background: none;
      font-size: 14px;
    }

    nav button.active {
      border-bottom: 3px solid #1976d2;
      color: #1976d2;
      font-weight: bold;
    }

    section {
      padding: 15px;
      display: none;
    }

    section.active {
      display: block;
    }

    .card {
      background: white;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 14px;
      box-sizing: border-box;
    }

    button.primary {
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
    }

    button.danger {
      background: #d32f2f;
      color: white;
      border: none;
    }

    .center {
      text-align: center;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>

<header>ðŸ“š Rakshapal Singh Library</header>

<nav>
  <button id="tab-home" class="active" onclick="openTab('home')">Home</button>
  <button id="tab-owner" onclick="openTab('owner')">Owner</button>
  <button id="tab-account" onclick="openTab('account')">Account</button>
</nav>

<section id="home" class="active">
  <div class="card">
    <h3>Welcome</h3>
    <p>
      Rakshapal Singh Library provides a disciplined and peaceful study environment.
      Public users can explore the app without login.
    </p>
  </div>
</section>

<section id="owner">
  <div class="card">
    <h3>Library Owner</h3>
    <p><b>Name:</b> Rakshapal Singh</p>
    <p><b>Email:</b> c.commando822@gmail.com</p>
    <p><b>Message:</b> Discipline, focus and consistency bring success.</p>
  </div>
</section>

<section id="account">

  <div id="publicView" class="card">
    <div id="recaptcha-container"></div>
    
    <h3>Account</h3>
    <p>Please login / sign up to manage your account.</p>
    <input type="tel" id="phone" placeholder="Enter mobile number (e.g. 9876543210)" />
    <button class="primary" onclick="sendOTP()">Send OTP</button>
  </div>

  <div id="otpView" class="card hidden">
    <h3>Verify OTP</h3>
    <input type="number" id="otp" placeholder="Enter 6-digit OTP" />
    <button class="primary" onclick="verifyOTP()">Verify</button>
  </div>

  <div id="userView" class="hidden">
    <div class="card center">
      <img src="https://via.placeholder.com/80" style="border-radius:50%" alt="User Profile">
      <p id="userPhone"></p>
    </div>

    <div class="card">
      <h3>Select Shift Plan</h3>
      <select id="shift" onchange="calculateAmount()">
        <option value="day">Day â‚¹500 / 28 days</option>
        <option value="night">Night â‚¹400 / 28 days</option>
        <option value="both">Both â‚¹700 / 28 days</option>
      </select>

      <input type="number" id="days" placeholder="Number of days (max 140)" oninput="calculateAmount()" />
      <p><b>Total Amount:</b> â‚¹<span id="amount">0</span></p>
      <button class="primary">Pay Now</button>
    </div>

    <div class="card">
      <button class="danger" onclick="logout()">Logout</button>
    </div>
  </div>
</section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithPhoneNumber, RecaptchaVerifier } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDjn6u195jqewM53qb2xnrPruFnMOELAcc",
    authDomain: "rakshapal-singh-library-ded2e.firebaseapp.com",
    projectId: "rakshapal-singh-library-ded2e",
    storageBucket: "rakshapal-singh-library-ded2e.firebasestorage.app",
    messagingSenderId: "988319651464",
    appId: "1:988319651464:web:477fa283cddb1d1123713d"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // FIXED: Pointing to the specific empty container div
  window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 
    size: 'invisible' 
  });

  let confirmationResult;

  window.sendOTP = function () {
    const phoneInput = document.getElementById("phone").value;
    if(!phoneInput) { alert("Please enter a phone number"); return; }
    
    const phone = "+91" + phoneInput;
    
    signInWithPhoneNumber(auth, phone, window.recaptchaVerifier)
      .then(result => {
        confirmationResult = result;
        document.getElementById("publicView").classList.add("hidden");
        document.getElementById("otpView").classList.remove("hidden");
      })
      .catch(err => {
        alert("Error: " + err.message);
        // Reset reCAPTCHA so user can try again
        window.recaptchaVerifier.render().then(widgetId => {
           grecaptcha.reset(widgetId);
        });
      });
  };

  window.verifyOTP = function () {
    const code = document.getElementById("otp").value;
    if(!code) { alert("Please enter the OTP"); return; }

    confirmationResult.confirm(code).then(result => {
      document.getElementById("otpView").classList.add("hidden");
      document.getElementById("userView").classList.remove("hidden");
      document.getElementById("userPhone").innerText = result.user.phoneNumber;
    }).catch(() => alert("Invalid OTP. Please try again."));
  };

  window.logout = function () {
    auth.signOut();
    location.reload();
  };
</script>

<script>
  function openTab(tab) {
    document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
    document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
    document.getElementById(tab).classList.add("active");
    document.getElementById("tab-" + tab).classList.add("active");
  }

  function calculateAmount() {
    const shift = document.getElementById("shift").value;
    const days = Number(document.getElementById("days").value || 0);

    let rate = 0;
    if (shift === "day") rate = 500 / 28;
    if (shift === "night") rate = 400 / 28;
    if (shift === "both") rate = 700 / 28;

    document.getElementById("amount").innerText = Math.round(rate * days);
  }

  // Register Service Worker for PWA
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js").catch(err => console.log("SW registration failed", err));
  }
</script>

</body>
</html>
